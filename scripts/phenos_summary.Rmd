---
title: "phenos_summary"
output: html_document
date: "2024-06-13"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F)

lapply(c("tidyverse", "data.table", "paletteer", "ggpubr",
         "R3port", "xtable", "knitr", "tinytex"),  library, character.only = TRUE)

source("../scripts/pantry.R", echo=F)

```


```{r}

###############################
##   Load data by ancestry   ##
###############################

# system arguments
EUR=c("European"="EUR")

#load data for EUR ancestry
EUR.df <- readRDS(paste0("../data/processed/ukb_analysis_", EUR, ".rda")) %>%
  mutate(taster_status = factor(taster_status, levels=c("Nontaster", "Taster","Supertaster", "Other"))) 

#load dietPCs
dietPCs.dat <- readRDS(paste0("../data/processed/diet/ukb_EUR_dietPCs.rda"))

```


# ===================================================================
### Inclusion/Exclusion criteria
# * No diabetes data (Eastwood algorithm + HbA1c <5.7%)
# * Complete data for glucose, genetic ancestry, and behavioral/SES covariates

## Planned sensitivity analysis
# * Restrict to individuals with plausible total energy intakes (600-4000 kcal/d)
# ===================================================================

```{r incl-anc}

# Sample inclusions
EUR.df %>% 
  mutate(N_geno = ifelse(is.na(haplo_0) == F & is.na(haplo_1) == F, "1", "0")) %>%
  filter(N_geno == 1) %>%
  select(starts_with("N_")) %>% 
  reframe(N_European=n_pct(N_Ancestry, level="1"),
          N_geno=n_pct(N_geno, level="1"),
          N_contrl=n_pct(N_contrl, level="1"),
          N_contrl_compl=n_pct(N_contrl_compl, level="1"),
          N_contrl_compl_kcal=n_pct(N_contrl_compl_kcal, level="1"),
          N_contrl_compl_kcal_taste=n_pct(N_contrl_compl_kcal_taste, level="1")) %>% 
  t()

# "Common" TAS2R38 hapotypes & diplotypes (>0.005)
common_diplos <- names(which(prop.table(table(EUR.df$diplos_common))>0.001))

analysis <- EUR.df %>% filter(N_contrl_compl == 1) %>%
  filter(is.na(haplo_0) == F & is.na(haplo_1) == F)

dim(analysis) #N=241,752
```

# =======================
## TAS2R38 Haplotypes 
# =======================

```{r haplos}

## Add haplo_0_aa and haplo_1_aa to analysis.l dataframe list
analysis <- analysis %>% left_join(geno_to_aa.fun(analysis), by = "id")

## Summarize by ANC
tab_haplos_AA <- analysis %>%
   select(id, haplo_0_aa, haplo_1_aa) %>%
  pivot_longer(-id, values_to="haplo") %>%
  group_by(haplo) %>%
  reframe(n=n(), pct=(n()/nrow(.))*100) %>%
  arrange(n) %>%
  mutate(haplo_order = factor(haplo, levels=haplo[order(n, decreasing = T)])) %>%
  #Filter to "common" haplotypes (>1% of the cohort; >0.005, frequency)
  filter(pct>0.05)

plot_haplos_AA <- tab_haplos_AA %>% 
  ggplot(aes(x=haplo_order, y=pct, fill=haplo_order)) + 
  geom_bar(stat = "identity") + 
  scale_x_discrete(name = "TAS2R38 Haplotypes") +
  scale_y_continuous(limits=c(0,62), breaks=seq(0,60,10)) +
  ylab("Frequency (%)") + 
  scale_fill_manual(values = palettes$nature_haplos, name="TAS2R38 Haplotypes (n)") + 
  ggtheme +
    theme(axis.text.x = element_text(size=8, angle=25, hjust=1, color = "black"), 
          axis.text.y = element_text(size=8, color = "black"),
          axis.title = element_text(color = "black", face = "bold", size=10),
          legend.position = "bottom") +
    geom_text(aes(label=n), vjust=-0.35, size=3.0)

plot_haplos_AA %>% ggsave(filename="../output/EUR_plot_haplo_005_AA.pdf", height = 4, width=4.5)

```

# ======================================
# TAS2R38 diplotypes 
# ======================================

```{r diplos, fig.asp=0.55, out.height="50%", out.width="75%", warning=F}

analysis <- analysis %>% 
  mutate(diplos_common_AA=gsub("CAT", "AVI", gsub("CAC", "AVV", gsub("CGT", "AAI", gsub("CGC", "AAV", 
         gsub("GGC", "PAV", gsub("GGT", "PAI", gsub("GAT", "PVI", gsub("GAC", "PVV", diplos_common)))))))))

## Create variable in analysis for **common diplotypes**
common_diplos_AA <- names(which(prop.table(table(analysis$diplos_common_AA))>0.005))
analysis <- analysis %>%
  mutate(diplos_AA = ifelse(diplos_common_AA %in% common_diplos_AA, diplos_common_AA, NA))

tab_diplos_AA <- analysis %>% 
  filter(complete.cases(diplos_AA)) %>% #diplos_common_AA %in% diplos_common_AA) %>% 
  reframe(n=table(diplos_AA), pct=prop.table(table(diplos_AA)), diplos_AA=names(table(diplos_AA))) %>%
  arrange(-n) %>% 
  mutate(color = factor(ifelse(diplos_AA == "AVI/AVI", "Nontaster",
                                 ifelse(diplos_AA == "AVI/PAV", "Taster",
                                        ifelse(diplos_AA == "PAV/PAV", "Supertaster", "Other"))),
                          levels=c("Nontaster","Taster","Supertaster","Other"))) %>%
  mutate(diplos_AA_order=factor(diplos_AA, levels=diplos_AA[order(n, decreasing=T)])) %>%
  #filter to "common" diplotypes (>0.005, frequency)
  filter(pct>0.005)


# Save diplos_AA_ordered variable in anallysis
analysis <- analysis %>% mutate(
  diplos_AA = factor(diplos_AA, levels=c(tab_diplos_AA$diplos_AA_order)))


## Panel plot of diplotype distributions by anvestry group
plot_diplo_AA <- tab_diplos_AA %>%
  ggplot(aes(x=diplos_AA_order, y=pct*100, fill=diplos_AA_order)) + 
  geom_bar(stat = "identity") + 
  scale_x_discrete(name = "TAS2R38 Diplotypes") +
  scale_y_continuous(limits=c(0,52), breaks=seq(0,50,10)) +
  ylab("Frequency (%)") + 
  scale_fill_manual(values = palettes$nature_diplosAA, name="TAS2R38 Diplotypes") + 
  ggtheme +
    theme(axis.text.x = element_text(size=8, angle=25, hjust=1, color = "black"), 
          axis.text.y = element_text(size=8, color = "black"),
          axis.title = element_text(color = "black", face = "bold", size=10),
          legend.position = "bottom") +
  geom_text(aes(label=n), vjust=-0.35, size=3.0)

plot_diplo_AA %>% ggsave(filename="../output/EUR_plot_diplo_005_AA.pdf", height = 4, width=6)


# =========================================
# TAS2R38 haplotypes & diplotypes - panel
# =========================================

plot_haplo_diplo_AA <- ggarrange(plot_haplos_AA, plot_diplo_AA, ncol=2, widths=c(0.75,1), align = c("hv"), labels=c("A", "B"),
          common.legend = T, legend = "none")

plot_haplo_diplo_AA
#plot_haplo_diplo_AA %>% ggsave(filename="../output/EUR_plot_haplo_diplo_005_AA_v2.pdf", height=4, width=9)
  
```

# ============================================================================================================
## First, we examined demogaphic, lifestyle and SES characteristics among TAS2R38 diplotypes
# most sensitive bitter taste receptor (i.e., the Supertaster diplotype).
# ============================================================================================================

```{r descr-taste}

## Demographic, behavioral & risk factors
tab_descrBydiplo_AA <- analysis %>%
  group_by(diplos_common_AA) %>%
  reframe(
    N=n(),
    Age=mean_sd(age, d=0),
    Female=n_pct(sex, level = "Female", d=0),
    BMI=mean_sd(bmi, d=1),
    Smoke_Current=n_pct(smoke_level.lab, level="Current", d=0),
    Smoke_Previous=n_pct(smoke_level.lab, level="Previous", d=0),
    Smoke_Never=n_pct(smoke_level.lab, level="Never", d=0),
    PA_Low=n_pct(pa_met_excess_lvl, level="Low", d=0),
    PA_Moderate=n_pct(pa_met_excess_lvl, level="Moderate", d=0),
    PA_High=n_pct(pa_met_excess_lvl, level="High", d=0),
    Alchohol_Daily=n_pct(alch_freq.lab, level="Daily or almost daily", d=0),
    Alcohol_3to4wk=n_pct(alch_freq.lab, level="3-4 per week", d=0),
    Alcohol_1to2wk=n_pct(alch_freq.lab, level="1-2 per week", d=0), 
    Alcohol_1to3mnth=n_pct(alch_freq.lab, level="1-3 per month", d=0), 
    Alcohol_occsions=n_pct(alch_freq.lab, level="Special occasions only", d=0), 
    Alcohol_never=n_pct(alch_freq.lab, level="Never", d=0),
    Alcohol_g=mean_sd(ALC, d=0),
    Educ_College=n_pct(educ_level.lab, level="College or university degree", d=0),
    Educ_NVQ_HND=n_pct(educ_level.lab, level="NVQ/HND or equivalent", d=0),
    Educ_OthrProfessional=n_pct(educ_level.lab, level="Other professional qualifications", d=0),
    Educ_ASlevel=n_pct(educ_level.lab, level="A/AS levels or equivalent", d=0),
    Educ_GCSE=n_pct(educ_level.lab, level="O/GCSE levels or equivalent", d=0),
    Educ_CSEs=n_pct(educ_level.lab, level="CSEs or equivalent", d=0),
    Educ_None=n_pct(educ_level.lab, level="None of the above ", d=0),
    Income_lt18k=n_pct(income_level.lab, level="lt_18000", d=0),
    Income_18to31k=n_pct(income_level.lab, level="from_18000_to_30999", d=0),
    Income_31to50k=n_pct(income_level.lab, level="from_31000_to_51999", d=0),
    Income_50to100k=n_pct(income_level.lab, level="from_52000_to_100000", d=0),
    Income_gt100k=n_pct(income_level.lab, level="gt_100000", d=0),
    Glucose=mean_sd(glu, d=1),
    HbA1c=mean_sd(hba1c_max, d=1),
    SBP=mean_sd(sbp, d=0),
    DBP=mean_sd(dbp, d=0),
    Triglyceride=mean_sd(tg, d=1),
    LDL=mean_sd(ldl, d=1),
    HDL=mean_sd(hdl, d=1),
    Coffee_cupsperday=mean_sd(coffee_QT, d=1),
    Tea_cupsperday=mean_sd(tea_QT, d=1),
    Raw_vegetables=mean_sd(raw_veg_QT, d=1),
    Cooked_vegetables=mean_sd(cooked_veg_QT, d=1)) %>% 
  t()

tab_descrBydiplo_AA %>% write.csv("../data/processed/analysis/EUR_descr_diplos_AA.csv")

# For total cohort
tab_descr %>% write.csv("../data/processed/analysis/EUR_descr_total.csv")


## P-values using ANOVA or Chi Square
cont_vars <- c("age", "bmi", "glu", "hba1c", "tg_log", "ldl", "hdl")
cat_vars <- c("sex", "smoke_level.lab", "physact_level", "alch_freq.lab", "educ_level.lab", "income_level.lab")

do.call(rbind.data.frame, lapply(cont_vars, function(var) {
  cbind.data.frame(
    Var=var, 
    P_Ftest=anova(lm(formula(paste0(var, "~taster_status+age+sex+fast_cat")), data=analysis))$'Pr(>F)'[1]
  )
}))

do.call(rbind.data.frame, lapply(cat_vars, function(var) {
  cbind.data.frame(
    Var=var, 
    P_ChiSqt=chisq.test((analysis %>% select(var))[[1]], analysis$diplos_AA)$p.value
  )
}))


```


# ============================================================================================================
## Next we examined diet patterns among TAS2R38 diplotypes (to confirm the diplotype corresponding to the 
# most sensitive bitter taste receptor (i.e., the Supertaster diplotype).
# ============================================================================================================

```{r compare-PC1}

dietPC.rot <- dietPCs.dat$rotation %>% 
  as.data.frame() %>%
  mutate(Diet=diet_labels[rownames(.)], .before=PC1) %>%
  arrange(PC1)

plot_dietPC_waterfall.fun <- function(dPC.df, nPCs=10) {
  dietPC.rot %>%
    select(Diet, c(paste0("PC", 1:nPCs))) %>%
    mutate(Diet=factor(Diet, levels=Diet[order(PC1, decreasing=T)])) %>%
    pivot_longer(-Diet) %>% 
    mutate(name=factor(name, levels=c(paste0("PC", 1:nPCs)), labels=c(paste0("Diet PC", 1:nPCs)) )) %>%
    mutate(direction = factor(ifelse(value>0.2, "Positive/Major", ifelse(value<0.2 & value>0, "Positive/Minor", 
                                     ifelse(value<0 & value>-0.2, "Negative/Minor", "Negative/Major"))),
                              levels=c("Positive/Major", "Positive/Minor", "Negative/Minor", "Negative/Major"))) %>%
    ggplot(aes(x=value, y=Diet, fill=direction)) + 
    facet_wrap(~name, ncol=nPCs/2) + 
    geom_col() + ylab("") + xlab("Rotated Factor Loadings") +
    geom_vline(xintercept = c(-0.2, 0.2), color = "black", linetype = "dashed") +
    geom_vline(xintercept = 0, color = "black") +
    scale_fill_manual(values=palettes$nature_main4, name = "Factor Loadings") +
    ggtheme_waterfall
}

plot_dietPC_waterfall.fun(dPC, nPCs = 6)

## dietPC as heatmap
library(gplots)
hm_palette <- colorRampPalette(c("#888363", "white", "#435269"))(n=100)

dietPC.mat <- as.matrix(dietPC.rot[,-1])
rownames(dietPC.mat) <- dietPC.rot$Diet
pdf("../output/plot_hm_dietPC.pdf", height=4, width=12)
heatmap.2(dietPC.mat,
          col=hm_palette,
          scale = "none", 
          linecol =  "black",
          Rowv=F, Colv=F,
          colsep = seq(0,24,1), sepwidth = 0.1,
          density.info = "none", trace = "none", margins = c(5,10),
          dendrogram = "none", #key="False",
          cexRow = 0.55, cexCol = 0.75,
          offsetRow=0, offsetCol = 0) 
dev.off()

```

After deriving the diet patterns, we examined how adherence to the patterns differs by [common] TAS2R38 diplotypes

```{r}

library(emmeans)
dietPCs <- c(paste0("dietPC", 1:24))

# ============================================================
# Calculate EMMs for dPCs by diplotype, adjusting for age+sex
# ============================================================
emm_diplos_dPCs.l <- lapply(dietPCs, function(d) {
  get_emm.fun(exposure = "diplos_AA", reference="AVI/AVI", outcome = d, covars = "age+sex") 
}) ; names(emm_diplos_dPCs.l) = dietPCs
emm_diplos_dPCs <- do.call(rbind.data.frame, lapply(dietPCs, function(dPC) {
  emm_diplos_dPCs.l[[dPC]]$emm}
))

## For which dPCs do scores differ significantly by TAS2R38 genotype
emm_diplos_ftest <-as.data.frame(cbind(
  DietPC=1:24,
  F_stat=sapply(1:24, function(i) {emm_diplos_dPCs.l[[i]]$anv.p$`F value`[1]}),
  P_val=sapply(1:24, function(i) {emm_diplos_dPCs.l[[i]]$anv.p$`Pr(>F)`[1]})))

emm_diplos_ftest %>% filter(P_val <0.05)
emm_diplos_ftest %>% filter(P_val <0.05/24)
pcs_to_plot <- c(3,6,11,12,15,16) # only 15 is NOT significant after MC adjustment

# ==========================================
## Plot all F-test statistics for dPCs
# ==========================================

plot_bar_dPCftest <- f_barp %>%
  ggplot(aes(x=DietPC, y=F_stat)) + 
  geom_bar(stat="identity", fill="darkgrey") + 
  ggtheme + 
  theme(axis.text.x = element_blank(),
        axis.text.y=element_text(size=6), axis.title.y = element_text(size=7, face="bold"),
        axis.ticks.x = element_blank(),
        panel.border = element_blank(),
        panel.grid.major.y = element_line()) + 
  geom_hline(yintercept = 0, linewidth=0.25) +
  geom_vline(xintercept = 0.5, linewidth=0.25) +
  ylab("F statistic") + xlab("") +
  scale_x_continuous(limits=c(0,25), breaks=seq(1,24,1), expand = c(-0.01, 0))


plot_bar_dPCftest %>% ggsave(filename="../output/plot_dPC_Ftest.pdf", height=1.5, width=8)

```

```{r}

## EMM Plots of dPCs
plot_emm_dPC_signif <- emm_diplos_dPCs %>%
  filter(outcome %in% c(dietPCs[pcs_to_plot])) %>%
  mutate(outcome=factor(outcome, levels=c(paste0("dietPC", pcs_to_plot)), labels=c(paste0("Diet PC", pcs_to_plot)))) %>%
  mutate(exp=factor(exp, levels=c("AVI/AVI", "AVI/PAV",  "PAV/PAV", "AVI/AAV", "AAV/PAV"))) %>%
  ggplot(aes(x=exp, y=emmean, ymin=lower.CL, ymax=upper.CL, color=exp)) + 
  facet_wrap(~outcome, nrow=1) + 
  geom_hline(yintercept = 0, linewidth=0.15) +
  geom_point(size=2.25) + geom_errorbar(width=0.55) + 
  scale_color_manual(values=palettes$nature_diplosAA, name="TAS2R38 Diplotype") + 
  ylab("Marginal Mean (95% CI) PC score") + xlab("TAS2R38 Diplotype") +
  ggtheme+theme(axis.text.x = element_text(angle=35, hjust=1), legend.position = "bottom") +
    theme(axis.title = element_text(face="bold", color="black", size=8)) +
  theme(panel.grid.major.y = element_line())

plot_emm_dPC_signif %>% ggsave(filename="../output/plot_emm_dPC_signif.pdf", height=3, width=10)

```



```{r}

AAs <- c(" AVI/AVI", "  AVI/PAV", "  PAV/PAV", "  AAV/AVI", "  AAV/PAV")

## Print table of associations of Diplos with RG
read.csv("../data/processed/analysis/EUR_lm_diplo_x_rg.csv") %>% 
  mutate(beta_se = sprintf("%s (%s, %s)", round(beta, 3), round(beta-1.96*se, 3), round(beta+1.96*se, 3))) %>%
  mutate(Diplo = rep(AAs, 4), .before=beta) %>%
  select(model, Diplo, n, beta_se, p, f_p) %>%
  write.csv("../data/processed/analysis/EUR_tab_lm_rg_allModels_v2.csv")


## Random Glucose in all models ---------------------------
read.csv("../data/processed/analysis/EUR_lm_diplo_x_a1c.csv") %>% 
  mutate(beta_se = sprintf("%s (%s, %s)", round(beta, 3), round(beta-1.96*se, 3), round(beta+1.96*se, 3))) %>%
  mutate(Diplo = rep(AAs, 4), .before=beta) %>%
  select(model, Diplo, n, beta_se, p, f_p) %>%
  write.csv("../data/processed/analysis/EUR_tab_lm_a1c_allModels_v2.csv")

```


```{r}

## Glucose stratified by fasting time in all models ---------------------------
read.csv("../data/processed/analysis/EUR_lm_diplo_x_gluXfast.csv") %>%
  mutate(beta_se = sprintf("%s (%s, %s)", round(beta, 3), round(beta-1.96*se, 3), round(beta+1.96*se, 3))) %>%
  mutate(Diplo = rep(AAs, 20), .before=beta) %>%
  select(model_fast, model, fast, Diplo, n, beta_se, p, f_p) %>%
  write.csv("../data/processed/analysis/EUR_tab_lm_rg_fastcat_allModels_v2.csv")

# plot of EMM glucose by fasting time in diet patterns model
emm_gluXfast_diet <- read.csv("../data/processed/analysis/EUR_lm_diplo_x_gluXfast.csv")
emm_gluXfast_diet

```

```{r}

s_tab_lm_rg <- read.csv("../data/processed/analysis/EUR_lm_diplo_x_rg_plauskcal.csv")
s_tab_lm_a1c %>%
  mutate(beta_se = sprintf("%s (%s, %s)", round(beta, 3), round(beta-1.96*se, 3), round(beta+1.96*se, 3))) %>%
  select(model, fast, beta_se, p, f_p) %>%
  mutate(across(c(p, f_p), ~round(., digits=3))) %>%



s_tab_lm_a1c <- read.csv("../data/processed/analysis/EUR_lm_diplo_x_a1c_plauskcal.csv")


s_tab_lm_0to2g <- read.csv("../data/processed/analysis/EUR_lm_diplo_x_gluXfast_plauskcal.csv")











```















