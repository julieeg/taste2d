---
title: "Descriptives"
output: html_notebook
---

```{r setup, include=F}
knitr::opts_chunk$set(echo = FALSE, message = FALSE,warning = FALSE, fig.path = "../output/phenos_summary/")
suppressMessages(silent <- lapply(c("tidyverse", "data.table", "knitr", "kableExtra", "paletteer", "ggpubr"), 
                                  library, character.only = TRUE))
palettes <- list(NatComms=paletteer_d("ggsci::nrc_npg", n=10),
                 HeatMapOr=paletteer_d("ggsci::orange_material", n=10),
                 HeatMapYlRd=rev(paletteer::paletteer_c("grDevices::heat.colors", n=100)))
```

```{r basics}
# load basic functions
source("basic_functions.R", echo=F)

# set color palettes
palettes <- list(NatComms=paletteer_d("ggsci::nrc_npg", n=10),
                 HeatMapYlRd=rev(paletteer::paletteer_c("grDevices::heat.colors", n=100)))
Taster_palette_Labs <- c("Nontaster" = palettes$NatComms[1], "Taster"= palettes$NatComms[4], 
                         "Supertaster"= palettes$NatComms[3], "Other" = "grey50")

# set ggplot theme standards
ggplot_theme_standard_continuous <- theme_bw() + theme(
    axis.text.x = element_text(size=12, vjust=0.65, color = "black"),
    axis.text.y = element_text(size=12, color="black"), 
    strip.text=element_text(size=14, face="bold"),
    axis.title = element_text(size=14, color = "black")
)

ggplot_theme_standard_categorical <- theme_bw() + theme(
    axis.text.x = element_text(size=12, color = "black", angle=30, hjust=0.9),
    axis.text.y = element_text(size=12, color="black"), 
    strip.text=element_text(size=14, face="bold"),
    axis.title = element_text(size=14, color = "black")
)
```

```{r command-args}
args = commandArgs(trailingOnly = TRUE)
ANC = "EUR" #args[1]
```

```{r read-phenos}
analysis <- readRDS(paste0("../data/processed/ukb_analysis_", ANC, ".rda"))
dim(analysis)
```


### Exclusion criteria

* No diabetes (Eastwood algorithm + HbA1c <5.7%)
* Common TAS2R38 diplotype
* [ANC] genetic ancestry
* Complete data for glucose, genetic ancestry, covariates
* Plausible total energy intakes (600-4000 kcal/d)


```{r exclusion-criteria}
summarise_noNA <- function(x, varname, data=analysis) {
  return((analysis %>% select(c("id", x)) %>% mutate(noNA = ifelse(complete.cases(.), 1, 0)))$noNA) }

analysis <- analysis %>% 
  mutate(
    include_t2d_controls = ifelse(!is.na(t2d_case.f) & t2d_case.f == "Control", 1, 0),
    include_taster_diplotype = ifelse(is.na(taster_status) == T | taster_status == "Other", 0, 1),
    include_complete_glu = ifelse((summarise_noNA("glu") == 1), 1, 0),
    include_plausible_kcal = ifelse(TCALS <600 | TCALS > 4800 | is.na(TCALS)==T, 0, 1),
    #include_complete_agesexgPC = summarise_noNA(c("age", "sex", paste0("gPC", 1:10))),
    include_complete_fasting = summarise_noNA("fasting_hrs"),
    include_complete_covars = summarise_noNA(c("age", "sex", paste0("gPC", 1:10), "fasting_hrs", "bmi", 
                                         "smoke_level.lab", "pa_met_excess_lvl", "alch_freq.lab", "dietPC1", "FIB2CHO"))) %>%
  mutate(N_European = ifelse(ancestry == "EUR", 1, 0),
         N_controls = include_t2d_controls,
         N_cont_taste = include_t2d_controls==1 & include_taster_diplotype==1,
         N_cont_taste_kcal = include_t2d_controls==1 & include_taster_diplotype==1 & include_plausible_kcal==1,
         N_controls_taste_kcal_complete = include_t2d_controls==1 & include_taster_diplotype==1 & include_plausible_kcal==1 & 
           include_complete_glu==1 & include_complete_fasting==1 & include_complete_covars==1)

analysis %>%
  select(id, starts_with("N_")) %>%
  pivot_longer(-id, names_to="criterion") %>%
  group_by(criterion) %>%
  summarise(Yes = sum(value),
            No = sum(!value)) %>%
  setNames(c("Inclusion criterion", "Yes", "No")) %>%
  kable(caption = "Sample counts for inclusion criteria") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F, position = "left") 

```


\n

### Variable distributions
```{r descr-fns}
plot_continuous <- function(cont_var) {
  analysis %>% select(var=all_of(cont_var)) %>% filter(!is.na(var)) %>%
    ggplot(aes(x=var)) + geom_histogram(bins=30) +
    labs(title=cont_var, x=cont_var, y="frequency") #+
    #ggplot_theme_standard_continuous
}

plot_categorical <- function(cat_var) {
  analysis %>% 
    select(var=all_of(cat_var)) %>% filter(!is.na(var)) %>%
    ggplot(aes(x=factor(var))) + geom_bar(stat="count") +
    labs(title=cat_var, x=cat_var) +
    theme(axis.text.x = element_text(angle=35, vjust=0.75))
    #ggplot_theme_standard_categorical
}

```

```{r plot-phenos-2, fig.width=12, fig.height=3}
ggarrange(plot_categorical("t2d_case.f"), plot_categorical("taster_status"), ncol=2, widths = c(0.65, 1))
```

```{r plot-phenos-1, fig.height=12, fig.width=16}
ggarrange(
  ggarrange(plot_continuous("age"), plot_categorical("sex"), plot_continuous("bmi"), nrow=1, ncol=3),
  ggarrange(plot_categorical("smoke_level.lab"),  plot_categorical("pa_met_excess_lvl"), plot_categorical("alch_freq.lab"), 
            nrow=1, widths=c(0.85, 0.85, 1.25), align = "h"), nrow=2)
```

```{r plot-phenos-3, fig.width=12, fig.height=8}
ggarrange(plot_continuous("CHO2FIB"), plot_continuous("dietPC1"), plot_continuous("dietPC2"), 
          plot_continuous("dietPC3"), plot_continuous("dietPC4"), plot_continuous("dietPC5")
)
```

## Descriptive characteristics by Taster Status

##### TAS2R38 Diplotype breakdown
```{r}
diplo_gt05=names(which(prop.table(table(analysis$diplo))>0.0005))
as.data.frame(table(analysis$diplo)) %>% 
  filter(Var1 %in% diplo_gt05) %>%
  mutate(#order=1:nrow(.), 
         color = ifelse(Var1 == "CAT/CAT", "Nontaster",
                        ifelse(Var1 %in% c("CAT/GGC", "GGC/CAT"), "Taster",
                               ifelse(Var1 == "GGC/GGC", "Supertaster", "Other")))) %>%
  mutate(diplo_order=factor(Var1, levels=Var1[order(Freq, decreasing=T)])) %>%
  ggplot(aes(x=diplo_order, y=Freq/sum(Freq), fill=color)) + 
  geom_bar(stat = "identity") + 
  scale_x_discrete(name = "\n TAS2R38 Diplotypes") +
  ylab("Frequency (%)") + ylim(0, 0.35) +
  scale_fill_manual(values = Taster_palette_Labs, name="Taster Status") + 
  theme(axis.text.x = element_text(size=10, angle=35, vjust=0.65, color = "black"),
        axis.text.y = element_text(size=10, color = "black"),
        axis.title = element_text(color = "black", face = "bold")) +
  geom_text(aes(label=Freq), vjust=-1.15, size=3) + 
  ggtitle("TAS2R38 Diplotype Frequency Table") 

```

###### Basic phenotypes
```{r descr}
analysis %>% filter(complete.cases(taster_status)) %>%
  group_by(taster_status) %>%
  reframe(
    Age=mean_sd(age),
    Female=n_pct(sex, level = "Female"),
    BMI=mean_sd(bmi),
    Smoke_Current=n_pct(smoke_level.lab, level="Current"),
    Smoke_Previous=n_pct(smoke_level.lab, level="Previous"),
    Smoke_Never=n_pct(smoke_level.lab, level="Never"),
    PA_Low=n_pct(pa_met_excess_lvl, level="Low"),
    PA_Moderate=n_pct(pa_met_excess_lvl, level="Moderate"),
    PA_High=n_pct(pa_met_excess_lvl, level="High"),
    Alchohol_Daily=n_pct(alch_freq.lab, level="Daily or almost daily"),
    Alcohol_3to4wk=n_pct(alch_freq.lab, level="3-4 per week"),
    Alcohol_1to2wk=n_pct(alch_freq.lab, level="1-2 per week"), 
    Alcohol_1to3mnth=n_pct(alch_freq.lab, level="1-3 per month"), 
    Alcohol_occsions=n_pct(alch_freq.lab, level="Special occasions only"), 
    Alcohol_never=n_pct(alch_freq.lab, level="Never")
    ) %>% 
  t() %>% kable() %>%
  kable_styling(full_width = FALSE)
```

###### T2D/Cardiometabolic
```{r descr-t2d}
analysis %>% filter(complete.cases(taster_status)) %>%
  group_by(taster_status) %>%
  reframe(
    Glucose=mean_sd(glu),
    HbA1c=mean_sd(hba1c_max),
    SBP=mean_sd(sbp),
    DBP=mean_sd(dbp),
    Triglyceride=mean_sd(tg),
    LDL=mean_sd(ldl),
    HDL=mean_sd(hdl)) %>%
  t() %>% kable() %>%
  kable_styling(full_width = FALSE)
```

```{r descr-t2d-fasting}
# Glucose
analysis %>% filter(complete.cases(taster_status)) %>%
  group_by(fast_cat, taster_status) %>%
  reframe(Glucose=mean_sd(glu)) %>%
  pivot_wider(names_from="taster_status", values_from="Glucose") %>%
  kable(caption="Mean (SD) Glucose by Taster Status & Fasting Category") %>% 
  kable_styling(full_width = FALSE)
#HbA1c
analysis %>% filter(complete.cases(taster_status)) %>%
  group_by(fast_cat, taster_status) %>%
  reframe(HbA1c=mean_sd(hba1c_max)) %>%
  pivot_wider(names_from="taster_status", values_from="HbA1c") %>%
  kable(caption="Mean (SD) HbA1c by Taster Status & Fasting Category") %>% 
  kable_styling(full_width = FALSE)
```

#### Diet characteristics
###### Diet pattern factor loadings
```{r diet-patterns, fig.width=16, fig.height=8}
dietPC.dat <- readRDS(paste0("../data/processed/diet/ukb_", ANC, "_dietPCs.rda"))
as.data.frame(dietPC.dat$rotation) %>%
  mutate(diet=rownames(.)) %>%
  select(diet, c(paste0("PC", 1:10))) %>%
  mutate(diet=factor(diet, levels=diet[order(PC1, decreasing=T)])) %>%
  pivot_longer(-diet) %>% 
  mutate(direction = ifelse(value <=0, "neg", "pos")) %>%
  ggplot(aes(x=value, y=diet, fill=direction)) + 
  facet_wrap(~name, ncol=5) + 
  #geom_vline(xintercept = 0, color = "black") +
  geom_col() + ylab("Diet traits derived from UKB FFQ") + xlab("Rotated Factor Loadings") +
  geom_vline(xintercept = c(-0.2, 0.2), color = "black", linetype = "dashed") +
  geom_vline(xintercept = 0, color = "black") +
  scale_fill_manual(values=c(palettes$NatComms[7], palettes$NatComms[5]), 
                    name = "Direction of\nFactor Loading", labels = c("Negative", "Positive")) +
  theme_bw() +
  theme(panel.grid.major.x = element_blank(), panel.grid.minor.x = element_blank())
```

```{r diet-descr}
dietVars <- c("TCALS", "CHO_pct", "FIBER", "CHO2FIB", "FAT_pct", "PRO_pct", "ALC", paste0("dietPC", 1:10))
as.data.frame(analysis %>% filter(complete.cases(taster_status)) %>%
  group_by(taster_status) %>%
  reframe(
    Energy_kcal=mean_sd(TCALS),
    Carbohydrate_pct = mean_sd(CHO_pct),
    Fiber_g = mean_sd(FIBER),
    Carb_to_Fiber=mean_sd(CHO2FIB),
    Fat_pct = mean_sd(FAT_pct),
    Protein_pct = mean_sd(PRO_pct), 
    Alcohol_g=mean_sd(ALC),
    Diet_Pattern_PC1 = mean_sd(dietPC1),
    Diet_Pattern_PC2 = mean_sd(dietPC2),
    Diet_Pattern_PC3 = mean_sd(dietPC3),
    Diet_Pattern_PC4 = mean_sd(dietPC4),
    Diet_Pattern_PC5 = mean_sd(dietPC5),
    Diet_Pattern_PC6 = mean_sd(dietPC6),
    Diet_Pattern_PC7 = mean_sd(dietPC7),
    Diet_Pattern_PC8 = mean_sd(dietPC8),
    Diet_Pattern_PC9 = mean_sd(dietPC9),
    Diet_Pattern_PC10 = mean_sd(dietPC10)) %>% 
  t()) %>%
  mutate(P_Ftest=c(NA, sapply(dietVars, function(y) {
  anova(lm(formula(paste0(y, "~taster_status+age+sex")), data=analysis))$`P`[1]} ))) %>%
  kable() %>%
  kable_styling(full_width = FALSE)
```


