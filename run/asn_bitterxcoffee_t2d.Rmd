---
title: "ASN 2025 - TAS2R38 x Coffee on T2D"
output: html_document
date: "2025-01-15"
---

```{r setup, include=FALSE, echo=F}
knitr::opts_chunk$set(echo = F, error = F, warning = F, fig.align="center", 
                      out.width = "50%", out.height = "50%")

lapply(c("tidyverse", "data.table", "paletteer", "ggpubr", "emmeans", "ComplexHeatmap",
         "knitr", "DT", "xtable"),  library, character.only = TRUE)

# set default options for table printing
options(DT.options = list(pageLength = 1000), class="compact") 

# load pantry functions
source("../scripts/pantry/print_summary_table_fun.R", echo=F)
source("../scripts/pantry.R")

```


```{r load_data}

## Overview
#This document summarizes preliminary analyses, testing the potential interaction between TAS2R38 genotype x coffee intake on T2D status & T2D risk. 
#Subsample analyses were also conducted among T2D case/controls for a TAS2R38 x coffee interaction on T2D glycemic traits; random & 0-2hr glucose 


# load bitter/taste/coffee UKB dataframe (.Rda) 
btc <- readRDS("../data/processed/ASN_btc_data.rda")

# load analysis results
btc_results <- readRDS("../data/processed/archive/analysis/ASN_bitterxcoffee_t2d_main&interaction_v2.rda") 
main_effects.l = btc_results[[1]]
interaction_effects.l = btc_results[[2]]

# make variable vectors
taste_diplotypes = c("AVI/AVI", "AVI/PAV", "PAV/PAV")
coffee_cat4 = c(paste(c("0", "<=1", "2-3", "4-5", "6+"), "cups/d"))
coffee_cat5 = c(paste(c(0:4, "5+"), "cups/d"))

```


**Participant inclusion criteria:**

* TAS2R38 status (per PAV haplotype) 
* Available coffee intake data 
* Available covariate data (age, sex, gPCs, smoking status, physical activity, alcohol use, tea intake) 
* EUR genetic ancestry 
* T2D data available 


## Summary Tables

```{r 2x2} 

print_summary_table(data=btc, vars_to_summarize = c(
  coffee_QT = "Coffee intake, cups/d", 
  coffee_cat5 = "Coffee intake, 5-levels",
  t2d_case.f ="T2D, case/control"), digits=c(2,1,3),
  var_strat = "taste_diplos", var_strata_order = taste_diplotypes
  ) %>% kable(caption = "Table 1a. T2D status & coffee intake by TAS2R38 diplotype")

#print_glm(exposure = "taste_diplos.num", outcome="t2d_case", covariates = "age+sex", data=btc, label="P-trend, adjusting for age+sex") %>%
 # mutate(model="age+sex") %>% make_pretty_glm() %>% mutate(Exposure="TAS2R38, (per PAV haplotype)") %>% kable()

print_summary_table(data=btc, vars_to_summarize = c(
  coffee_QT = "Coffee intake, cups/d", 
  t2d_case.f ="T2D, case/control"), digits=c(1,1,3),
  var_strat = "coffee_cat4", var_strata_order = coffee_cat4
  ) %>% kable(caption = "Table 1b) T2D status & TAS2R38 diplotype by coffee intake (4-levels)")

```


***

## Participant characteristics

```{r table1_taste, echo=FALSE}

taste_diplotypes = c("AVI/AVI", "AVI/PAV", "PAV/PAV")
descr_vars = c(age="Age, year", sex= "Sex", bmi="BMI, kg/m2",
               smoke_level.lab="Smoking Status", cigarettes_per_day = "Cigarettes per day", 
               physact_level.lab="Physical Activity level", tea_QT = "Tea intake", 
               alch_freq.lab="Alcohol use frequency" #, income_level.lab="Income level", 
               #educ_level.lab="Education level"
               )

print_summary_table(data=btc, vars_to_summarize = descr_vars, var_strata = "taste_diplos",
                    var_strata_order = taste_diplotypes, digits = c(1,1,3)) %>%
  kable(caption="Table 1. Descriptive characteistics by TAS2R38 bitter taste diplotype")
  
```


***

## Statistical analysis:

Evaluate associations of each exposure TAS2R38 diplotype exposure and coffee intake variable with T2D status using 2 statistical models:

* TAS2R38: continuous (per, PAV haplotype) and categorical (pairwise comparisons among diplotpes)
* Coffee: continuous (cups/day) and categorical (0,1,2,3,4,5+ cups/d)

```{r}

cbind.data.frame(Model = c("Base", "Lifestyle"), 
                 Covariates = c("age, sex, 10 genetic PCs, and BMI", 
                                "Base + smoking status + physical activity + tea intake")) %>%
  kable()

```

\n

#### *Main effects of TAS2R38 on T2D status*
```{r}
# tas2r38 --> t2d
do.call(rbind.data.frame, main_effects.l$bitterADD_t2d) %>% make_pretty_glm() %>% 
  mutate(Exposure="(per PAV haplotype)") %>% kable(caption="Model 1A: Associations of TAS2R38 diplotype (additive & categorical) with T2D status")
do.call(rbind.data.frame, main_effects.l$bitter_t2d) %>% make_pretty_glm() %>% kable()
```

#### *Main effects of Coffee on T2D status*
```{r}
# coffee --> t2d
do.call(rbind.data.frame, main_effects.l$coffeeCAT5_t2d) %>% make_pretty_glm() %>% 
  kable(caption="Model 1B: Associations of Coffee intake (5-level categorical & continuous) with T2D status in a Base and Lifestyle model")
do.call(rbind.data.frame, main_effects.l$coffeeQT_t2d) %>% make_pretty_glm() %>% 
  mutate(Exposure="(cups/d)") %>% kable()
```

*Summary:*

* Haplotypes conferring *more sensitive* TAS2R38 receptors (PAV) are associated with *lower rates* of T2D 
* *Higher coffee* intake associates with *lower rates* of T2D 


#### *Interactions effects of TAS2R38 x Coffee on T2D status*

```{r}

interaction_effects.l <- lapply(interaction_effects.l, function(int) {names(int) = c("Base", "Lifestyle") ; return(int)})

print_interaction_aov <- function(int.l, d=2) {
  tab.l <- lapply(int.l, function(i) {
    tab <- i[["anova"]] %>% as.data.frame() %>% 
      rename(anova_p='Pr(>Chi)') %>%
      mutate(Exposure = gsub("taste_diplos", "TAS2R38 ", gsub(".num", "(per PAV)", 
                             gsub("coffee", "Coffee ", gsub("[_]QT", " (cups/d)", gsub("[_]cat*", "(categorical)", 
                                  gsub(":", " x ", rownames(.)))))))) %>%
      mutate('Anova_P' = format_p.fun(anova_p,3)) %>% 
      select(Exposure, Anova_P) 
    rownames(tab) <- NULL ; return(tab)
    }) ; Tab <- do.call(rbind.data.frame, tab.l) %>% mutate(Model=gsub("[.].*", "", rownames(.)), .before="Exposure") %>% as.tibble()
    return(Tab)
}

print_interaction_aov(interaction_effects.l$bitterxcoffee) %>% kable(caption="Model 2A: Interaction of TAS2R38 (categorical) x Coffee (cups/d) on T2D status")
print_interaction_aov(interaction_effects.l$bitterxcoffeeCAT5) %>% kable(caption="Model 2B: Interaction of TAS2R38 (categorical) x Coffee (5-levels) on T2D status")
print_interaction_aov(interaction_effects.l$bitterADDxcoffeeQT) %>% kable(caption="Model 2C: Interaction of TAS2R38 (per PAV) x Coffee (cups/d) on T2D status")
print_interaction_aov(interaction_effects.l$bitterADDxcoffeeCAT5) %>% kable(caption="Model 2D: Interaction of TAS2R38 (per PAV) x Coffee (5-levels) on T2D status")

```

*Summary: *
* Both exposures are independently associated with lower liklihood of T2D 
* No significant interactions of TAS2R38 on coffee intake with T2D status (cross-sectional) in the base or lifestyle adjusted models


```{r, out.height=5, out.width=5}

library(emmeans)
library("RColorBrewer")

# Fully-adjusted interaction model of TAS2R38 x cottee_QT
m_bitterxcoffeeQT <- interaction_effects.l$bitterxcoffee$Lifestyle$glm
int_bitterxcoffeeQT <- as.data.frame(emtrends(m_bitterxcoffeeQT, pairwise ~ taste_diplos, var = "coffee_QT")$emtrends)
kable(as.data.frame(int_bitterxcoffeeQT), caption = "Multiplicative Interactions of TAS2R38 x coffee (cups/d)")

int_bitterxcoffeeQT %>%
  rename(TAS2R38=taste_diplos, Beta=coffee_QT.trend, LCI=asymp.LCL, UCI=asymp.UCL) %>%
  mutate(or=exp(Beta), or.LCI=exp(LCI), or.UCI=exp(UCI)) %>%
  ggplot(aes(x=TAS2R38, y=or, ymin=or.LCI, ymax=or.UCI, color=TAS2R38)) +
  geom_hline(yintercept = 1, linetype="dashed", color="black") + 
  geom_point(size=2) + geom_errorbar(width=0.35) + 
  scale_y_log10() + ylim(0.95, 1.05) + 
  xlab("TAS2R38 diplotype") + ylab("log(odds) of Coffee-T2D assoc") + 
  scale_color_manual(values=c(brewer.pal(9,"Blues")[6:8])) +
  theme_bw()

```


```{r, include=F}

#### Following up with sub-sample analyses of T2D risk factors: random and 0-2hr glucose
#Testing to see if the protective effect of coffee on T2D is stronger among genetic supertasters

bitterxcoffee_glu <- readRDS("../data/processed/archive/analysis/ASN_bitterxcoffee_glu_interaction.rda")
bitterxcoffee_glu %>% kable()

```


## Incident T2D 

```{r incident}

incident.l <- readRDS("../data/processed/archive/analysis/ASN_bitterxcoffee_t2d_incident_maininteraction.rda")

print_incident <- function(mod, d, to_plot=F) { 
    tab <- cbind(summary(mod)$conf.int[,c(1,3:4)], P=summary(mod)$coef[,5]) %>% as.data.frame() %>%
      rename(HR='exp(coef)', HR.LCI='lower .95', HR.UCI='upper .95') %>%
      filter(startsWith(rownames(.), "taste") | startsWith(rownames(.), "coffee")) %>%
      mutate(across(starts_with("HR"), ~round(., 2))) %>%
      mutate(HR.95CI=sprintf("%s (%s, %s)", HR, HR.LCI, HR.UCI), P=format_p.fun(P)) %>%
      mutate(Exposure = gsub("taste_diplos", "TAS2R38 ", gsub(".num", "(per PAV)", 
                             gsub("coffee", "Coffee ", gsub("[_]QT", " (cups/d)", gsub("[_]cat5", "Intake, ", 
                                  gsub(":", " x ", rownames(.))))))))
    #if to_plot == T
    if(to_plot == T) { tab <- tab %>% select(Exposure, HR, HR.LCI, HR.UCI, P) %>%
      mutate(Level = gsub("TAS2R38 ", "", gsub("Coffee", "", gsub(" Intake, ", "", Exposure))), .after=Exposure) %>%
      mutate(Exposure = gsub(" .*", "", Exposure))
      } else {
      tab <- tab %>% select(Exposure, HR.95CI, P) } ; rownames(tab) <- NULL
      return(tab)
}

```

#### *Main effects of TAS2R38 and Coffee on T2D risk*
```{r}

library(RColorBrewer)

# Bitter --> T2D
incid_bitter <- rbind( print_incident(incident.l[[1]], to_plot = T), print_incident(incident.l[[2]], to_plot = T ) ) %>%
  bind_rows(cbind.data.frame(Exposure="TAS2R38", Level="AVI/AVI", HR=1.0, HR.LCI=NA, HR.UCI=NA, P=NA) %>% as.data.frame()) %>%
  mutate(Level = factor(Level, levels = c(taste_diplotypes, "(per PAV)")),
         Type = ifelse(Level == "(per PAV)", "Continuous", "Categorical"))
  
incid_bitter %>%
    ggplot(aes(x=Level, y=HR, ymin=HR.LCI, ymax=HR.UCI, color=Level, shape=Type)) + 
    geom_point(size=3) + geom_errorbar(width=0.35) + 
    geom_hline(yintercept = 1, color="black", linetype="dashed") +
    scale_color_manual(values=c(brewer.pal(9, "Blues")[c(6:8,4)])) + 
    scale_y_log10(limits=c(0.85, 1.1)) +
    xlab("TAS2R38 Genotype") + ylab("HR (95% CI) for Incident T2D") +
    theme_bw()

rbind.data.frame(print_incident(incident.l[[1]]), print_incident(incident.l[[2]])) %>% 
  kable(caption = "Model 3A: Associations of TAS2R38 (categorical & continuous) with incident T2D in a lifestyle-adjusted model")

# Coffee --> T2D
incid_coffee <- rbind( print_incident(incident.l[[3]], to_plot = T), print_incident(incident.l[[4]], to_plot = T ) ) %>%
  bind_rows(cbind.data.frame(Exposure="Coffee", Level="0 cups/d", HR=1.0, HR.LCI=NA, HR.UCI=NA, P=NA) %>% as.data.frame()) %>%
  mutate(Level = factor(Level, levels = c(coffee_cat5, "  (cups/d)"))) %>%
  mutate(Type = ifelse(Level == "  (cups/d)", "Continuous", "Categorical"))
  
incid_coffee %>%
    ggplot(aes(x=Level, y=HR, ymin=HR.LCI, ymax=HR.UCI, color=Level, shape=Type)) + 
    geom_point(size=3) + geom_errorbar(width=0.35) + 
    geom_hline(yintercept = 1, color="black", linetype="dashed") +
    scale_color_manual(values=c(brewer.pal(9, "Oranges")[c(4:9,3)])) + 
    scale_y_log10(limits=c(0.5, 1.5)) +
    xlab("Coffee Intake") + ylab("HR (95% CI) for Incident T2D") +
    theme_bw()

rbind.data.frame(print_incident(incident.l[[3]]), print_incident(incident.l[[4]])) %>% 
  kable(caption = "Model 3B: Associations of TAS2R38 (categorical & continuous) with incident T2D in a lifestyle-adjusted model")

```

#### *Interaction effects of TAS2R38 and Coffee on T2D risk*

```{r}

p_bitterxcoffee <- rbind.data.frame (print_incident(incident.l[[5]], to_plot = T), print_incident(incident.l[[6]], to_plot = T))

plot_incident_interaction <- function(mod) { 
    cbind(summary(mod)$conf.int[,c(1,3:4)], P=summary(mod)$coef[,5]) %>% as.data.frame() %>%
      rename(HR='exp(coef)', HR.LCI='lower .95', HR.UCI='upper .95') %>%
      filter(startsWith(rownames(.), "taste") | startsWith(rownames(.), "coffee")) %>%
      mutate(across(starts_with("HR"), ~round(., 2))) %>%
      mutate(HR.95CI=sprintf("%s (%s, %s)", HR, HR.LCI, HR.UCI), P=format_p.fun(P)) %>%
      mutate(Exposure = gsub("taste_diplos", "TAS2R38 ", gsub(".num", "(per PAV)", 
                             gsub("coffee", "Coffee ", gsub("[_]QT", " (cups/d)", gsub("[_]cat5", "Intake, ", 
                                  gsub(":", " x ", rownames(.)))))))) %>% 
      select(Exposure, HR, HR.LCI, HR.UCI, P) %>%
      mutate(Level = gsub("TAS2R38 ", "", gsub("Coffee", "", gsub(" Intake, ", "", Exposure))), .after=Exposure) %>%
      mutate(Exposure = gsub(" .*", "", Exposure)) %>%
    mutate(Estimate = c(rep("Main", 7), rep("Interaction", 10))) %>%
    filter(Estimate == "Interaction") %>%
    bind_rows(cbind.data.frame(Exposure="TAS2R38", Level="AVI/AVI x 0 cups/d", HR=1.0, HR.LCI=NA, HR.UCI=NA, P=NA) %>% as.data.frame()) %>%
  mutate(Level = factor(Level, levels = c(taste_diplotypes, "(per PAV)")),
         Type = ifelse(Level == "(per PAV)", "Continuous", "Categorical"))
 
     
      return(tab)
}


```

```{r}

incident.l[[5]] %>% print_incident() %>% kable(caption="Model 4A: Associations of TAS2R38 (categorical) x coffee (cups/d) on incident T2D")
incident.l[[7]] %>% print_incident() %>% kable(caption="Model 4B: Associations of TAS2R38 (per PAV haplotype) x coffee (cups/d) on incident T2D")
incident.l[[6]] %>% print_incident() %>% kable(caption="Model 4C: Associations of TAS2R38 (categorical) x coffee (4-level catgorical) on incident T2D")
incident.l[[8]] %>% print_incident() %>% kable(caption="Model 4D: Associations of TAS2R38 (per HAP haplotype) x coffee (4-level catgorical) on incident T2D")

```

*Summary: *
* TAS2R38 is associated with lower incident T2D, *only in the ineraction model and not in the main effects model*
* Interpretation of the HRs is confusing -- need to double check how to combine estimates across groups












```{r print=F, show=F}

print_interactions <- function(int.l, d) { 
  tab.l <- lapply(int.l, function(i) {
    tab <- i %>% as.data.frame() %>%
      rename(beta=Estimate, se='Std. Error', p='Pr(>|z|)') %>%
      mutate(Model = ifelse("tea_QT" %in% rownames(.), "Lifestyle", "Base")) %>%
      filter(startsWith(rownames(.), "taste") | startsWith(rownames(.), "coffee")) %>%
      mutate(or=exp(beta)) %>%
      mutate(or.lci = exp(beta-1.96*se), or.uci = exp(beta+1.96*se)) %>%
      mutate(across(starts_with("or"), ~round(., 2))) %>%
      mutate(OR.95CI=sprintf("%s (%s, %s)", or, or.lci, or.uci), P=ifelse(p<0.01, format(p, scientific = T, digits=2), round(p, 3))) %>%
      mutate(Exposure = gsub("taste_diplos", "TAS2R38 ", gsub(".num", "(per PAV)", 
                             gsub("coffee", "Coffee ", gsub("[_]QT", " (cups/d)", gsub("[_]cat*", "(categorical)", 
                                  gsub(":", " x ", rownames(.)))))))) %>%
      select(Model, Exposure, OR.95CI, P)
    rownames(tab) <- NULL
    if(tab$Model[1] == "Lifestyle") {tab <- tab %>% select(-"Exposure")}
    return(tab)
  }) #; Tab <- do.call(rbind.data.frame, tab.l) ; rownames(Tab) <- NULL
  #return(Tab)
}

#print_interactions(interaction_effects.l$bitterxcoffee) %>% kable(caption="Interaction of TAS2R38 (categorical) x Coffee (continuous; and categorical) on T2D status")
#print_interactions(interaction_effects.l$bitterADDxcoffeeQT) %>% kable() #caption="Interaction of TAS2R38 (additive; per PAV) x Coffee (5-levels) on T2D status"
#print_interactions(interaction_effects.l$bitterADDxcoffeeQT) %>% kable(caption="Interaction of TAS2R38 (additive; per PAV) x Coffee (continuous; and 5-levels) on T2D status")
#print_interactions(interaction_effects.l$bitterADDxcoffeeCAT5) %>% kable() #caption="Interaction of TAS2R38 (additive; per PAV) x Coffee (5-levels) on T2D status"


```
