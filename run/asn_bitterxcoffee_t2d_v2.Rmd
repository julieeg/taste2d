---
title: "ASN 2025 - TAS2R38 x Coffee on T2D"
output: html_document
theme: united
date: "2025-01-15"
---

```{r setup, include=FALSE, echo=F}
knitr::opts_chunk$set(echo = F, error = F, warning = F, fig.align="center", 
                      out.width = "65%", out.height = "65%")

lapply(c("tidyverse", "data.table", "paletteer", "ggpubr", "emmeans", "ComplexHeatmap",
         "knitr", "DT", "xtable"),  library, character.only = TRUE)

# set default options for table printing
options(DT.options = list(pageLength = 1000), class="compact") 

# load pantry functions
source("../scripts/pantry/print_summary_table_fun.R", echo=F)
source("../scripts/pantry.R")

```


```{r load_data}

## Overview
#This document summarizes preliminary analyses, testing the potential interaction between TAS2R38 genotype x coffee intake on T2D status & T2D risk. 
#Subsample analyses were also conducted among T2D case/controls for a TAS2R38 x coffee interaction on T2D glycemic traits; random & 0-2hr glucose 


# load bitter/taste/coffee UKB dataframe (.Rda) 
analysis <- readRDS("../data/processed/asn_coffee_incidt2d_data_postprocessed.rda")

# load analysis results
results <- readRDS("../data/processed/archive/analysis/ASN_bitterxcoffee_t2d_incident_maininteraction_v2.rda")

# make variable vectors
taste_diplotypes = c("AVI/AVI", "AVI/PAV", "PAV/PAV")
coffee_intake_cat4 = c(paste(c("0", "<=1", "2", "3", "4", ">=5")))

```


**Participant inclusion criteria:**

* TAS2R38 status (per PAV haplotype) 
* Available coffee intake data 
* Available covariate data (age, sex, gPCs, smoking status, physical activity, alcohol use, tea intake) 
* EUR genetic ancestry **for TAS2R38 genotype
* T2D incident/time to event data available 


## Summary Tables

```{r 2x2} 

print_summary_table(data=analysis, vars_to_summarize = c(
  coffee_intake_cat4 = "Coffee intake, 4-levels", coffee_QT="Coffee intake", t2d = "Incident T2D"), 
  var_strat = "taste_diplos", var_strata_order = taste_diplotypes, factor_vars = "t2d") %>% 
  kable(caption = "Table 1a. T2D status & coffee intake by TAS2R38 diplotype")

```


***

## Participant characteristics

```{r table1_taste, echo=FALSE}

taste_diplotypes = c("AVI/AVI", "AVI/PAV", "PAV/PAV")
descr_vars = c(age="Age, year", sex= "Sex", Body_mass_index_BMI.21001="BMI, kg/m2",
               smoking_qualy="Smoking Status", smoking_quantity = "Cigarettes per day", 
               PA_miss="Missing PA data", MET_minutes="Physical Actvity, MET/wk", tea = "Tea intake", 
               alcohol_four="Alcohol use frequency" #, income_level.lab="Income level", 
               #educ_level.lab="Education level"
               )

print_summary_table(data=analysis, vars_to_summarize = descr_vars, var_strata = "taste_diplos",
                    var_strata_order = taste_diplotypes, digits = c(1,1,3)) %>%
  kable(caption="Table 1. Descriptive characteistics by TAS2R38 bitter taste diplotype")
  
```


***

## Statistical analysis

Evaluate associations of each exposure TAS2R38 diplotype exposure and coffee intake variable with T2D status using 2 statistical models:

* TAS2R38: continuous (per, PAV haplotype) and categorical (pairwise comparisons among diplotpes)
* Coffee: continuous (cups/day) and categorical (0,1,2,3,4,5+ cups/d)

Regression Model: age, sex, 10 genetic PCs, smoking status, smoking quantity, PA missing, PA (MET/wk), tea intake

```{r incident}

results.l <- readRDS("../data/processed/archive/analysis/ASN_bitterxcoffee_t2d_incident_maininteraction_v2.rda")
results_adjbmi.l <- readRDS("../data/processed/archive/analysis/ASN_bitterxcoffee_t2d_incident_maininteraction_adjbmi_v2.rda")

maineffects.l <- list(main=results.l[[1]], bmi=results_adjbmi.l[[1]])
interactioneffects.l <- list(main=results.l[[2]], bmi=results_adjbmi.l[[2]])

print_incident <- function(mod, d, to_plot=F) { 
    tab <- cbind(summary(mod)$conf.int[,c(1,3:4)], P=summary(mod)$coef[,5]) %>% as.data.frame() %>%
      rename(HR='exp(coef)', HR.LCI='lower .95', HR.UCI='upper .95') %>%
      filter(startsWith(rownames(.), "taste") | startsWith(rownames(.), "coffee")) %>%
      mutate(across(starts_with("HR"), ~round(., 2))) %>%
      mutate(HR.95CI=sprintf("%s (%s, %s)", HR, HR.LCI, HR.UCI), P=format_p.fun(P)) %>%
      mutate(Exposure = gsub("taste_diplos", "TAS2R38 ", gsub("_ADD", "(per PAV)", 
                             gsub("coffee", "Coffee ", gsub("[_]QT", " (cups/d)", gsub("[_]intake_cat4", "Intake, ", 
                                  gsub(":", " x ", rownames(.))))))))
    #if to_plot == T
    if(to_plot == T) { tab <- tab %>% select(Exposure, HR, HR.LCI, HR.UCI, P) %>%
      mutate(Level = gsub("TAS2R38 ", "", gsub("Coffee", "", gsub(" Intake, ", "", Exposure))), .after=Exposure) %>%
      mutate(Exposure = gsub(" .*", "", Exposure))
      } else {
      tab <- tab %>% select(Exposure, HR.95CI, P) } ; rownames(tab) <- NULL
      return(tab)
}

```


#### *Main effects of TAS2R38 and Coffee on incident T2D*
```{r, include=T, echo=F}
cbind(Lifestyle_Model=paste0(c("age", "sex", paste0("gPC", 1:10), 
                               "smoking_qualy", "smoking_quantity", "alcohol_four", "tea",  
                               "PA_miss", "MET_minutes" , "tea"), collapse = "+"),
                 Lifestlye_BMI_Model=c("Lifestyle Model + bmi(kg/m2)")) %>%
  kable() 

interactions.l <- list("taste_diplos*coffee_intake_cat4", "taste_diplos_ADD*coffee_intake_cat4", 
                       "taste_diplos*coffee_QT", "taste_diplos_ADD*coffee_QT")

model_lifestyle <- paste0(c("age", "sex", paste0("gPC", 1:10), 
                    "smoking_qualy", "smoking_quantity", "alcohol_four", "tea",  
                    "PA_miss", "MET_minutes" , "tea"), collapse = "+")

```
```{r, echo=F}
## Model
lapply(interactions.l, function(i) formula(paste0("Surv(time_to_event, t2d) ~", i, "+", model_lifestyle)))

```

```{r}

library(RColorBrewer)

# Bitter --> T2D
list(
  rbind.data.frame(print_incident(maineffects.l$main[[1]]), print_incident(maineffects.l$main[[2]])) %>% 
    mutate(Model="Lifestyle", .before="Exposure"),
  rbind.data.frame(print_incident(maineffects.l$bmi[[1]]), print_incident(maineffects.l$bmi[[2]])) %>% 
    mutate(Model="Lifestyle+BMI", .before="Exposure")) %>%
  kable(caption = "Model 3A: Associations of TAS2R38 (categorical & continuous) with incident T2D in a lifestyle-adjusted model")

incid_bitter <- rbind( print_incident(maineffects.l$bmi[[1]], to_plot = T), print_incident(maineffects.l$bmi[[2]], to_plot = T ) ) %>%
  bind_rows(cbind.data.frame(Exposure="TAS2R38", Level="AVI/AVI", HR=1.0, HR.LCI=NA, HR.UCI=NA, P=NA) %>% as.data.frame()) %>%
  mutate(Level = factor(Level, levels = c(taste_diplotypes, "(per PAV)")),
         Type = ifelse(Level == "(per PAV)", "Continuous", "Categorical")) %>% 
  arrange(Type)
  
incid_bitter %>%
    ggplot(aes(x=Level, y=HR, ymin=HR.LCI, ymax=HR.UCI, color=Level, shape=Type)) + 
    geom_point(size=3) + geom_errorbar(width=0.35) + 
    geom_hline(yintercept = 1, color="black", linetype="dashed") +
    scale_color_manual(values=c(brewer.pal(9, "Blues")[c(6:8,4)])) + 
    scale_y_log10(limits=c(0.85, 1.1)) +
    xlab("TAS2R38 Genotype") + ylab("HR (95% CI) for Incident T2D")


# Coffee --> T2D
list(
  rbind.data.frame(print_incident(maineffects.l$main[[3]])) %>% mutate(Model="Lifestyle", .before="Exposure"),
  rbind.data.frame(print_incident(maineffects.l$bmi[[3]])) %>% mutate(Model="Lifestyle+BMI", .before="Exposure")) %>%
  kable(caption = "Model 3B: Associations of TAS2R38 (categorical) with incident T2D in a lifestyle-adjusted model")

incid_coffee <- print_incident(maineffects.l$bmi[[3]], to_plot = T) %>%
  bind_rows(cbind.data.frame(Exposure="Coffee", Level="0", HR=1.0, HR.LCI=NA, HR.UCI=NA, P=NA) %>% as.data.frame()) %>%
  mutate(Level = factor(Level, levels = coffee_intake_cat4)) %>%
  mutate(Type = ifelse(Level == "  (cups/d)", "Continuous", "Categorical"))
  
incid_coffee %>%
    ggplot(aes(x=Level, y=HR, ymin=HR.LCI, ymax=HR.UCI, color=Level, shape=Type)) + 
    geom_point(size=3) + geom_errorbar(width=0.35) + 
    geom_hline(yintercept = 1, color="black", linetype="dashed") +
    scale_color_manual(values=c(brewer.pal(9, "Oranges")[c(4:9,3)])) + 
    scale_y_log10(limits=c(0.7, 1.3)) +
    xlab("Coffee Intake") + ylab("HR (95% CI) for Incident T2D")


```

#### *Interaction effects of TAS2R38 and Coffee on T2D risk*

```{r}

p_bitterxcoffee <- print_incident(interactioneffects.l$bmi[[1]], to_plot = T)

p_bitterxcoffee %>% kable(caption="Interaction of TAS2R38 (cateogrical) x Coffee (categorical) on incident T2D in a lifestyle+bmi-adjusted model")

maineffect_terms <- c(taste_diplotypes, coffee_intake_cat4)

print_incident(interactioneffects.l$bmi[[1]], to_plot = T)  %>%
    filter(!Level %in% maineffect_terms) %>%
    separate(Level, sep=" x ", into=c("TAS2R38", "Coffee")) %>%
    mutate(TAS2R38 = factor(TAS2R38, levels=taste_diplotypes),
           Coffee = factor(Coffee, levels=coffee_intake_cat4)) %>%
    ggplot(aes(x=Coffee, group=TAS2R38, y=HR, ymin=HR.LCI, ymax=HR.UCI, color=TAS2R38)) +
    geom_hline(yintercept = 1, linetype="dashed") + 
    geom_point(size=2, position=position_dodge(0.55)) + 
    geom_errorbar(linewidth=0.35, width=0.25, position=position_dodge(0.55)) + 
   scale_color_manual(values=c(brewer.pal(9, "Blues")[c(6,8)])) + 
  scale_y_log10() +
  ggtitle("T2D ~ TAS2R38*Coffee+Lifestyle+BMI")

```

```{r}

add_int <- readRDS("../data/processed/asn_coffe_add_interaction.rda")

print_incident(add_int, to_plot=T) %>%
  separate(Level, sep=" x ", into=c("TAS2R38", "Coffee")) %>%
    mutate(TAS2R38 = factor(TAS2R38, levels=taste_diplotypes),
           Coffee = factor(Coffee, levels=coffee_intake_cat4)) %>%
    ggplot(aes(x=Coffee, group=TAS2R38, y=HR, ymin=HR.LCI, ymax=HR.UCI, color=TAS2R38)) +
    geom_hline(yintercept = 1, linetype="dashed") + 
    geom_point(size=2, position=position_dodge(0.55)) + 
    geom_errorbar(linewidth=0.35, width=0.25, position=position_dodge(0.55)) + 
   scale_color_manual(values=c(brewer.pal(9, "Blues")[c(6:8)])) + 
  scale_y_log10() + 
  ggtitle("Additive Interactions (T2D ~ TAS2R38:Coffee+Lifestyle+BMI)")

```

Stratified analyses by TAS2R38 genotype
```{r}
library(survival)
coxph_stratified_adjbmi.l <- lapply(taste_diplotypes, function(x) {
  coxph(formula(paste0("Surv(time_to_event, t2d) ~", "coffee_intake_cat4+", m_lifestyle_bmi)), data = incid %>% filter(taste_diplos == x))
})

print_incident(coxph_stratified_adjbmi.l[[1]]) %>% mutate(Taste=rep("AVI/AVI", 5), .before=Exposure) %>% t() %>% kable()
print_incident(coxph_stratified_adjbmi.l[[2]]) %>% mutate(Taste=rep("PAV/AVI", 5), .before=Exposure)%>% t() %>% kable()
print_incident(coxph_stratified_adjbmi.l[[3]]) %>% mutate(Taste=rep("PAV/PAV", 5), .before=Exposure)%>% t() %>% kable()

```








