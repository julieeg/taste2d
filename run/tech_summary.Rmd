---
title: "sensitivity_summary-technical covariates & other glucose measures"
output: html_document
date: "2024-08-29"
---


```{r setup, include=FALSE, echo=F}
knitr::opts_chunk$set(echo = F, error = F, warning = F, out.width = "100%", 
                      out.height = "80%", fig.align="center", fig.width=10)

lapply(c("tidyverse", "data.table", "paletteer", "ggpubr", "gplots",
         "R3port", "xtable", "knitr", "tinytex"),  library, character.only = TRUE)

source("../scripts/pantry/pantry.R", echo=F)

```

```{r}
###############################
##   Load data for EUR only  ##
###############################

# system arguments
EUR=c("European"="EUR")
tag="v4"

# load analysis dataframe
all <- readRDS(paste0("../data/processed/ukb_analysis_", EUR, ".rda")) %>%
  mutate(n_glucose_sensitivity_all=ifelse(n_geno==1 & n_t2d_contrl==1 & n_covars==1 & n_fast==1 & n_fast_24hr==1,1,0))

glucose <- all %>%
  filter(ancestry=="EUR" & n_geno==1 & n_t2d_contrl == 1 &
           n_glu == 1 & n_complete == 1 & n_fast_24hr == 1) %>%
  filter(find_outliers.fun(glu)==0) %>%
  mutate(n_24hr.lab = ifelse(n_24hr==1, "Has 24HR", "No 24HR")) %>%
  mutate(n_24hr_plaus.lab = factor(ifelse(n_24hr_plaus, "Plausible 24HR", "No 24HR"), levels=c("Plausible 24HR", "No 24HR")))

# load additional glucose data
glu_biochem <- readRDS("../data/processed/ukb_glucose_assays.rda")

glucose <- all %>% 
   filter(n_geno == 1 & n_t2d_contrl == 1 & n_covars == 1 & n_fast == 1 & n_fast_24hr == 1) %>% 
  left_join(glu_biochem, by = "id") %>% 
  #left_join(glu_nmr_processed, by = "id") %>%
  mutate(
    n_gluB.0 = recode_na_as.fun(gluB.0),
    n_gluB.1 = recode_na_as.fun(gluB.1)) %>% 
  mutate(
    dilution_pct.0 = dilution.0*100,
    dilution_pct.1 = dilution.1*100) %>%
  mutate(n_24hr.lab = ifelse(n_24hr == 1, "Complete 24HR", "No 24HR")) %>% 
  mutate(fast_cat=factor(fast_cat, levels=c("0to2hr", "3hr", "4hr", "5hr", "6+hr")))

# Lists of strata
n_24hr.l <- unique(glucose$n_24hr.lab)
fast_cat.l <- levels(glucose$fast_cat)
```


## Sensitivity analysis: Examine TAS2R38-glucose relations by 24HR data

Sensitivity subsample
* EUR participants
* T2D controls
* Complete genotyping, glucose (biochemical) & confounders
* Stratified by: complete/missing 24HR data (no energy restriction)
* Outliers: glucose values greater than |5SD| from measure mean

```{r}
# add vars for keep (in range=1/0) & outlier (outlier=1/0)
glucose <- glucose %>% 
  mutate(
    gluB_keep.0 = remove_outliers.fun(gluB.0), gluB_keep.1 = remove_outliers.fun(gluB.1)) %>% mutate(
    n_gluB_outlier.0 = find_outliers.fun(gluB.0), n_gluB_outlier.1 = find_outliers.fun(gluB.1)) %>% mutate(
    n_gluB_keep.0=recode_na_as.fun(gluB_keep.0), n_gluB_keep.1=recode_na_as.fun(gluB_keep.1)
    )

# function to recode parameter variables as NA for outliers of glu
recode_outlier_as_na.fun <- function(data, var_name, suffix="keep") {
  v<-gsub(".*[.]", "", gsub(".lab", "", var_name))
  temp <- data %>% select(var=all_of(var_name), glu=paste0("gluB.",v)) %>%
    mutate(char = ifelse(find_outliers.fun(glu, SDs=5)==1, NA, as.character(var)),
           num = ifelse(find_outliers.fun(glu, SDs=5)==1, NA, var))
  if(is.numeric(temp$var)) {temp <- temp %>% select(set_to_na="num") } else 
    if (is.character(temp$var)) { temp <- temp %>% select(set_to_na="char") } else 
      if(is.factor(temp$var)) { temp <- temp %>% mutate(set_to_na = factor(var, levels=c(levels(temp$var)))) %>%
        select(set_to_na) } ; new_var <- temp %>% rename_at(
      "set_to_na", ~gsub(paste0("[.]",v), paste0("_", suffix, ".", v), var_name)) 
  return(new_var)
}  

glucose <- glucose %>% mutate(
  recode_outlier_as_na.fun(., "dilution.0"), recode_outlier_as_na.fun(., "dilution.1"),
  recode_outlier_as_na.fun(., "dilution_pct.0"), recode_outlier_as_na.fun(., "dilution_pct.1"),
  recode_outlier_as_na.fun(., "gluB_aliquot.0.lab"), recode_outlier_as_na.fun(., "gluB_aliquot.1.lab"),
  recode_outlier_as_na.fun(., "gluB_correction_type.0.lab"), recode_outlier_as_na.fun(., "gluB_correction_type.1.lab"),
  recode_outlier_as_na.fun(., "gluB_correction_reason.0.lab"), recode_outlier_as_na.fun(., "gluB_correction_reason.1.lab"),
  recode_outlier_as_na.fun(., "gluB_missing.0.lab"), recode_outlier_as_na.fun(., "gluB_missing.1.lab"),
  recode_outlier_as_na.fun(., "gluB_reportable.0.lab"), recode_outlier_as_na.fun(., "gluB_reportable.1.lab")
) 

```


```{r}
n_sensitivity <- c(n_geno = "Genotyping, n(%)", n_t2d_contrl="T2D controls, n(%)" ,
  n_covars="Complete covariate data, n(%)", n_fast="Complete fasting data, n(%)",
  n_fast_24hr="Complete fasting data for <24hr, n(%)", n_24hr= "Available 24HR data, n (%)",
  n_glucose_sensitivity_all="Total sample for sensitivity analysis, N (%)")
print_summary_table(data=all, var_strata = F, vars_to_summarize = n_sensitivity,
                    factor_vars = c(names(n_sensitivity)), p_print=F) %>% 
  kable(caption="Sensitivity analysis sample among all EUR participants")

# Descriptive
decr_vars <- c(
  taste_diplos = "TAS2R38 diplotype",
  age="Age, years", sex="Sex",
  bmi="BMI, kg/m2", smoke_level.lab="Smoking",
  physact_level="Physical Activity, MET/wk",
  alch_freq.lab="Alcohol Frequency", educ_level.lab="Education Level",
  educ_isced.lab="Education Level (ISCED)",
  income_level.lab = "Income Level")

print_summary_table(data=glucose, var_strata = "n_24hr.lab", vars_to_summarize = decr_vars,
                    factor_vars = c("taste_diplos", "smoke_level.lab", "physact_level",
                                    "alch_freq.lab", "educ_level.lab", "educ_isced.lab", "income_level.lab"), p_print=T) %>% 
  kable(caption="Sample characteristics by 24HR data availability")
```

******

## Are the differences in glucose by 24HR due to *assay performance*?
#### Look at differences in *Glucose*
```{r} 
print_summary_table(data=glucose, vars_to_summarize = c(gluB_keep.0="Blood glucose at v0, mmol/L", 
                    gluB_keep.1="Blood glucose at v1, mmol/L"), digits = c(3,1,30),
                    var_strata = "n_24hr.lab", p_types = "descriptive") %>%
  kable(caption = "Glucose at v0 & v1 by 24HR data") 

p_bar_glucose_24hr <- glucose %>% group_by(n24HR=n_24hr.lab) %>%
  reframe(mean=mean(gluB_keep.0, na.rm=T), sd=sd(gluB_keep.0, na.rm=T)) %>%
  ggplot(aes(x=n24HR, y=mean-4, ymin=mean-4-sd, ymax=mean-4+sd, fill=n24HR)) +
  geom_bar(stat="identity", position=position_dodge(0.9)) + 
  geom_errorbar(position=position_dodge(0.9), linewidth=0.55, width=0.35) + 
  scale_y_continuous(breaks=seq(0,1.5,0.5), labels=seq(0,1.5,0.5)+4) + 
  ylab("Blood glucose") + xlab(" ") +
  scale_fill_manual(values=palettes$has_24hr) + ggtheme_basic + 
  ggtitle(paste0("Glucose by 24HR data")) 
  
p_box_gluc_24hr <- glucose %>% 
  select(n24HR=n_24hr.lab, Glucose=gluB_keep.0) %>%
  filter(complete.cases(n24HR)) %>%
  ggplot(aes(x=n24HR, y=Glucose, fill=n24HR)) +
  geom_boxplot() + geom_hline(yintercept = mean(glucose$gluB_keep.0, na.rm=T)) +  xlab("24HR data") + 
  ylab("Glucose, mmol/L") + scale_fill_manual(values=palettes$has_24hr, name="24HR data") + 
  theme(legend.position = "bottom") + ggtheme_basic#+ ggtitle(paste0("Glucose by 24HR data")) 

ggarrange(p_bar_glucose_24hr, p_box_gluc_24hr, nrow=1, ncol=2, align = "hv", common.legend = T)

# By fasting time
do.call(rbind.data.frame, lapply(fast_cat.l, function(f) {
  print_summary_table(vars_to_summarize = c(gluB_keep.0=paste0(f, " glucose at v0, mmol/L"), 
                    gluB_keep.1=paste0(f, " glucose at v1, mmol/L")), digits = c(3,1,6),
                    var_strata = "n_24hr.lab", p_types = "descriptive", data=glucose %>%
                      filter(fast_cat == f)) }) ) %>% 
  kable(caption = "Glucose at v0 & v1 by fasting category and 24HR data") 

p_gluc_24hr_fasting <- glucose %>% 
  group_by(Fasting=fasting_hrs.0, n24HR=n_24hr.lab) %>%
  reframe(mean=mean(gluB_keep.0, na.rm=T), sd=sd(gluB_keep.0, na.rm=T)) %>%
  ggplot(aes(x=Fasting, y=mean-4, ymin=mean-4-sd, ymax=mean-4+sd, fill=n24HR)) +
  scale_y_continuous(limits=c(0,2.5), breaks=seq(0,2.5,0.5), labels=seq(0,2.5,0.5)+4) +
  scale_x_continuous(breaks=seq(0,23,1), labels=seq(1,24,1)) +
  geom_bar(stat="identity", position=position_dodge(0.9)) + 
  geom_errorbar(position=position_dodge(0.8), linewidth=0.45, width=0.35) +
  geom_hline(yintercept = mean(glucose$gluB_keep.0, na.rm=T)-4, linetype = "dashed") +
  xlab("Fasting time, hrs") + ylab("Glucose, mmol/L") +
  scale_fill_manual(values=palettes$has_24hr, "24HR data?") + ggtheme_basic +
  ggtitle("Glucose by fasting hrs & 24HR data")

p_gluc_24hr_fast_cat <- glucose %>% 
  group_by(Fasting_Category=fast_cat, n24HR=n_24hr.lab) %>%
  reframe(mean=mean(gluB_keep.0, na.rm=T), sd=sd(gluB_keep.0, na.rm=T)) %>%
  ggplot(aes(x=Fasting_Category, y=mean-4, ymin=mean-4-sd, ymax=mean-4+sd, fill=n24HR)) +
  scale_y_continuous(limits=c(0,2), breaks=seq(0,2,0.5), labels=seq(0,2,0.5)+4) +
  geom_bar(stat="identity", position=position_dodge(0.9)) + 
  geom_errorbar(position=position_dodge(0.8), linewidth=0.45, width=0.35) +
  geom_hline(yintercept = mean(glucose$gluB_keep.0, na.rm=T)-4, linetype = "dashed") +
  xlab("Fasting Category") + ylab("Glucose, mmol/L") +
  scale_fill_manual(values=palettes$has_24hr, "24HR data?") + ggtheme_basic +
  ggtitle("Glucose by fasting category & 24HR data")

ggarrange(p_gluc_24hr_fasting, p_gluc_24hr_fast_cat, nrow=2, ncol=1, common.legend = T)
```

Summary

* Glucose is *significantly* higher for participants that completed 24HR vs. those that didn't, at baseline (visit 0) but NOT at visit 1 (~5 years later).
* At visit 0, glucose is *significantly* higher for those that completed 24HR vs. those that didn't for *at all categorical fasting windows* at visit 0 but NOT at visit 1.

### Do differences in assay performance by 24HR explain any differences in glucose?
**Estimated fractional dilution**
```{r}
print_summary_table(data=glucose, vars_to_summarize = c(
  dilution_pct_keep.0 = "Sample dilution at v0, %", dilution_pct_keep.1 = "Sample dilution at v1, %"), 
  digits = c(4,1,10), var_strata = "n_24hr.lab", p_types = "descriptive") %>%
  kable(caption = "Description of blood assays by 24HR data") ; 

p_bar_dilute_24hr <- glucose %>% group_by(n24HR=n_24hr.lab) %>%
  reframe(mean=mean(dilution.0, na.rm=T), sd=sd(dilution.0, na.rm=T)) %>%
  ggplot(aes(x=n24HR, y=mean-0.98, ymin=mean-0.98-sd, ymax=mean-0.98+sd, fill=n24HR)) +
  geom_bar(stat="identity", position=position_dodge(0.9)) + 
  scale_y_continuous(limits=c(0,0.03), breaks=seq(0,0.03,0.005), labels=seq(0,0.03,0.005)+0.98) +
  geom_errorbar(position=position_dodge(0.9), linewidth=0.55, width=0.15) + 
  geom_hline(yintercept = 1-0.985) +  xlab("24HR data") + 
  ylab("Sample dilution fraction, %") + scale_fill_manual(values=palettes$has_24hr, name="24HR data") + 
  theme(legend.position = "bottom") + ggtitle(paste0("Sample dilution by 24HR data")) + 
  ggtheme_basic

p_box_dilute_24hr <- glucose %>% 
  select(n24HR=n_24hr.lab, Dilution=dilution_keep.0) %>%
  filter(complete.cases(n24HR)) %>%
  ggplot(aes(x=n24HR, y=Dilution, fill=n24HR)) +
  geom_boxplot() + geom_hline(yintercept = 1) +  xlab("24HR data") +
  ylab("Sample dilution fraction, %") + scale_fill_manual(values=palettes$has_24hr, name="24HR data") + 
  theme(legend.position = "bottom") + ggtheme_basic

ggarrange(p_bar_dilute_24hr, p_box_dilute_24hr, nrow=1, ncol=2, align = "hv", common.legend = T)

# by fasting time
do.call(rbind.data.frame, lapply(fast_cat.l, function(f) {
  print_summary_table(vars_to_summarize = c(dilution_pct_keep.0=paste0(f, " sample dilution at v0, %"), 
                    dilution_pct_keep.1=paste0(f, " sample dilution at v1, %")), digits = c(3,1,6),
                    var_strata = "n_24hr.lab", p_types = "descriptive", data=glucose %>%
                      filter(fast_cat == f)) }) ) %>% 
  kable(caption = "Sample dilution (%) at v0 & v1 by fasting category and 24HR data") 

p_dilute_24hr_fasting <- glucose %>% 
  group_by(Fasting=fasting_hrs.0, n24HR=n_24hr.lab) %>%
  reframe(mean=mean(dilution_keep.0, na.rm=T), sd=sd(dilution_keep.0, na.rm=T)) %>%
  ggplot(aes(x=Fasting, y=mean-0.987, ymin=mean-0.987-sd, ymax=mean-0.987+sd, fill=n24HR)) +
  scale_y_continuous(limits=c(0,0.02), breaks=seq(0,0.02,0.005), labels=seq(0,0.02,0.005)+0.987) +
  scale_x_continuous(breaks=seq(0,23,1), labels=seq(1,24,1)) +
  geom_bar(stat="identity", position=position_dodge(0.9)) + 
  geom_errorbar(position=position_dodge(0.9), linewidth=0.45, width=0.35) +
  geom_hline(yintercept = 1-0.987, linetype = "dashed") +
  xlab("Fasting time, hrs") + ylab("Sample Dilution Fraction, %") +
  scale_fill_manual(values=palettes$has_24hr, "24HR data?") + ggtheme_basic +
  theme(legend.position = "bottom") + ggtitle("Dilution by fasting & 24HR data") 

p_dilute_24hr_fast_cat <- glucose %>% 
  group_by(Fasting_Category=fast_cat, n24HR=n_24hr.lab) %>%
  reframe(mean=mean(dilution_keep.0, na.rm=T), sd=sd(dilution_keep.0, na.rm=T)) %>%
  ggplot(aes(x=Fasting_Category, y=mean-0.987, ymin=mean-0.987-sd, ymax=mean-0.987+sd, fill=n24HR)) +
  scale_y_continuous(limits=c(0,0.02), breaks=seq(0,0.02,0.005), labels=seq(0,0.02,0.005)+0.987) +
  geom_bar(stat="identity", position=position_dodge(0.9)) + 
  geom_errorbar(position=position_dodge(0.9), linewidth=0.45, width=0.35) +
  geom_hline(yintercept = 1-0.987, linetype = "dashed") +
  xlab("Fasting category") + ylab("Sample Dilution Fraction, %") +
  scale_fill_manual(values=palettes$has_24hr, "24HR data?") + ggtheme_basic +
  theme(legend.position = "bottom") + ggtitle("Dilution by fasting category & 24HR data") 

ggarrange(p_dilute_24hr_fasting, p_dilute_24hr_fast_cat, nrow=2, ncol=1, align = "hv", common.legend = T)
```

Summary:
* Samples had *significantly* less dilution (higher concentrations) for those with 24HR data vs. those without at visit 0 but NOT at visit 1
* At visit 0, across all fasting windows, samples had *significantly* less dilution (higher concentrations) for those with 24HR data vs. those without but there were no differences between dilution within any fasting window at visit 1

**Aliquot**
```{r}
print_summary_table(data=glucose, vars_to_summarize = c(
  gluB_aliquot_keep.0.lab = "Aliquot # at v0", gluB_aliquot_keep.1.lab = "Aliquot # at v1"), 
  digits = c(4,1,10), var_strata = "n_24hr.lab", p_types = "descriptive") %>%
  kable(caption = "Description of blood assays by 24HR data") 

aliquot.l <- list("Manual", "Aliquot 1", "Aliquot 2")
do.call(rbind.data.frame, lapply(aliquot.l, function(a) {
  print_summary_table(vars_to_summarize = c(
    gluB_keep.0=paste(a, ": glucose at v0"), dilution_pct_keep.0=paste(a,": sample dilution at v0")),
    var_strata = "n_24hr.lab", p_types = "descriptive", digits=c(4,1,10), data = glucose %>% 
      filter(gluB_aliquot_keep.0.lab == a)) } )) %>% 
  kable(caption = "Do glucose and dilution fraction differ by aliquot number and 24HR")

p_box_dilute_24hr_aliquot <- glucose %>% 
  select(n24HR=n_24hr.lab, Dilution=dilution_keep.0, Aliquot=gluB_aliquot_keep.0.lab) %>%
  filter(complete.cases(Aliquot)) %>%
  ggplot(aes(x=Aliquot, y=Dilution, fill=n24HR)) + 
  geom_boxplot() + geom_hline(yintercept = 1) +  xlab("Aliquot # x 24HR data") + 
  ylab("Sample dilution fraction, %") + scale_fill_manual(values=palettes$has_24hr, name="24HR data") + 
  theme(legend.position = "bottom") + ggtitle(paste0("Sample dilution by Aliquot & 24HR data")) + 
  ggtheme_basic

p_box_glu_24hr_qliquot <- glucose %>% 
  select(n24HR=n_24hr.lab, Glucose=gluB_keep.0, Aliquot=gluB_aliquot_keep.0.lab) %>%
  filter(complete.cases(Aliquot)) %>%
  ggplot(aes(x=Aliquot, y=Glucose, fill=n24HR)) + #facet_grid(~n24HR) +
  geom_boxplot() + xlab("Aliquot # x 24HR data") + 
  geom_hline(yintercept = mean(glucose$gluB_keep.0, na.rm=T)) +
  ylab("Blood glucose, mmol/L") + scale_fill_manual(values=palettes$has_24hr, name="24HR data") + 
  theme(legend.position = "bottom") + ggtitle(paste0("Glucose by Aliquot & 24HR data"))  +
  ggtheme_basic

p_bar_gluc_24hr_aliquot <- glucose %>% 
  group_by(Aliquot=gluB_aliquot_keep.0.lab, n24HR=n_24hr.lab) %>%
  reframe(mean=mean(gluB_keep.0, na.rm=T), sd=sd(gluB_keep.0, na.rm=T)) %>%
  filter(complete.cases(Aliquot)) %>%
  ggplot(aes(x=Aliquot, y=mean-4, ymin=mean-4-sd, ymax=mean-4+sd, fill=n24HR)) +
  scale_y_continuous(limits=c(0,2.5), breaks=seq(0,2.5,0.5), labels=seq(0,2.5,0.5)+4) +
  geom_bar(stat="identity", position=position_dodge(0.9)) + 
  geom_errorbar(position=position_dodge(0.8), linewidth=0.45, width=0.35) +
  geom_hline(yintercept = mean(glucose$gluB_keep.0, na.rm=T)-4, linetype = "dashed") +
  xlab("Aliquot #") + ylab("Glucose, mmol/L") +
  scale_fill_manual(values=palettes$has_24hr, "24HR data?") + ggtheme_basic

ggarrange(p_box_glu_24hr_qliquot, p_bar_gluc_24hr_aliquot, nrow=1, ncol=2, align = "hv", common.legend = T)
```
*Note* the significant differene in sample dilution b/w 24HR groups at both time points; but much more so at v0")


### Recalling differences in SES by 24HR
Re-examing SES differences by 24HR and whether this captures the influence of 24HR on glucose
```{r}
ses_vars <- c(income_level.lab="Income Level", educ_level.lab="Education Level")
print_summary_table(data=glucose, vars_to_summarize = ses_vars, factor_vars = names(ses_vars), 
  digits = c(4,1,10), var_strata = "n_24hr.lab", p_types = "descriptive") %>%
  kable(caption = "Description of SES by 24HR data") 
```

#### Statistical comparisons
```{r}
m_assay.l <- list(AgeSex=paste0("age+sex"),AgeSexFasting=paste0("age+sex+fasting_hrs.0"),
  "Dilution/Aliquot"=paste0("age+sex+fasting_hrs.0+dilution_keep.0+gluB_aliquot_keep.0.lab"),
  "+SES"=paste0("age+sex+fasting_hrs.0+dilution_keep.0+gluB_aliquot_keep.0.lab+income_level.lab+educ_level.lab"))
lm_n24hr_gluc_x_assay <- do.call(rbind.data.frame, lapply(1:4, function(m) {
  print_lm(exposure = "n_24hr.lab", outcome = "gluB_keep.0", covariates = m_assay.l[[m]], 
  label = names(m_assay.l)[m], data=glucose, lm_trend = F) }))

make_pretty_lm(lm_n24hr_gluc_x_assay) %>% kable(caption= "Effect of 24hr on glucose is 
substantially (but not fully) attenuated when adjusting for assay performance parameters")
```


Summary
 
* 24HR significantly predicts blood glucose (P_24hr_=2.45x10-60, with sex and age adjustment). 
* However the effect is substantially attenuated when additionally adjusting for dilution fraction (P_24hr_ = 3.15x10-6 with dilution adjustment), and moreso when adjusting for aliquot number (P_24hr_=0.0012 with aliquot adjustment), although the effect remains significant

# Sensitivity Models

* Base model: age, sex, 10 genetic PCs, BMI 
* BMI model: Base model + BMI 
* Lifestyle model: BMI model + smoking, physical activity level, alcohol intake 
* Diet model: lifestyle model + 10 diet PCs (capturing food choices) 
* SES model: diet model + income level + education level 
* Assay model: SES model + assay metrics 
* Complete 24HR: Fiber2Carb model:SES model + Fiber-to-carbohydrate ratio 
* Complete 24HR: Assay model: Fib2Carb ratio + Assay metrics 
 
```{r}
sensitivity <- glucose %>% 
  filter(find_outliers.fun(glu)==0) %>% mutate(
  sensitivity_strata_aliquots_A1 = ifelse(gluB_aliquot.0 == 1,1,0)) #N=241378
n_24hr.l <-c("Complete 24HR", "No 24HR")

# set up sensitivity models
m_base = "age+sex+gPC1+gPC2+gPC3+gPC4+gPC5+gPC6+gPC7+gPC8+gPC9+gPC10+fast_cat"
m_bmi = paste0(m_base, "+bmi")
m_lifestyle = paste0(m_bmi, "+smoke_level.lab+physact_level+alch_freq.lab")
m_diet = paste0(m_lifestyle, "+dietPC1+dietPC2+dietPC3+dietPC4+dietPC5+dietPC6+dietPC7+dietPC8+dietPC9+dietPC10")
m_ses = paste0(m_diet, "+income_level.lab+educ_level.lab")
m_assay = paste0(m_ses, "+dilution_keep.0+gluB_aliquot_keep.0.lab")
m_f2c = paste0(m_ses, "+FIB2CHO")
m_ses_assay_f2c = paste0(m_assay, "+FIB2CHO")

models.l = list("Base"= m_base, "Diet"=m_diet, "SES"=m_ses, 
                "Assay"=m_assay, "SES+Fib2Carb"=m_f2c, "Fib2Carb+Assay"=m_ses_assay_f2c)
                
models.nofast.l <- as.list(gsub("[+]fast_cat", "", models.l)) ; names(models.nofast.l) <- names(models.l)
models.noaliquot.l <- as.list(gsub("[+]gluB_aliquot_keep.0.lab", "", models.l)) ; names(models.noaliquot.l) <- names(models.l)
models.nofast.noaliquot.l <- as.list(gsub("[+]gluB_aliquot_keep.0.lab", "", models.nofast.l))
names(models.nofast.noaliquot.l) <- names(models.l)
```

## Run sensitivity models adjusting for SES
```{r}
lm_ses_diplo_rg <- do.call(rbind.data.frame, lapply(1:4, function(m) {
  make_pretty_lm(print_lm(exposure = "taste_diplos", outcome = "glu", label=names(models.l)[m], 
           covariates = models.l[[m]], lm_trend = T, data = sensitivity)) }))
lm_ses_diplo_rg %>% kable(caption="TAS2R38 diplotype & RG with SES adjustment")

## TAS2R38 diplotype & 2hrGlu  ------------------------
lm_ses_diplo_2hrg <- make_pretty_lm(do.call(rbind.data.frame, lapply(1:4, function(m) {
  print_lm(exposure = "taste_diplos", outcome = "glu", label=names(models.nofast.l)[m], 
           covariates = models.nofast.l[[m]], lm_trend = T, data = sensitivity %>%
             filter(fast_cat == "0to2hr")) })))
lm_ses_diplo_2hrg %>% kable(caption="TAS2R38 diplotype & 2hr glucose with SES adjustment")

## TAS2R38 diplotype & HbA1c in diet patterns model ------------------------
lm_ses_diplo_a1c <- do.call(rbind.data.frame, lapply(1:4, function(m) {
  make_pretty_lm(print_lm(exposure = "taste_diplos", outcome = "hba1c", label=names(models.l)[m], 
           covariates = models.l[[m]], lm_trend = T, data = sensitivity)) }))
lm_ses_diplo_a1c %>% kable(caption="TAS2R38 diplotype & HbA1c with SES adjustment")

```

## Run sensitivity models adjusting for Fiber-to-Carb ratio, among participants with 24HR data
### Additionally adjust for assay performance metrics, given apparent differences between groups
Based on the differenes in assay performance between the two subgroups, and the effect these differences seem to have on glucose levels between the strata, we ran sensitivity models to see what happens to the overall effect when we additionally adjusting for assay performance, and if the apparent differences by 24HR are attenuated when adjusting, as well.   

**Stratified models by 24HR data**
```{r}
bind_rows(do.call(rbind.data.frame, lapply(4:6, function(m) { 
  make_pretty_lm(print_lm(
    exposure = "taste_diplos", outcome = "gluB_keep.0", label= paste0("Has 24HR: RG~", names(models.l)[m]), 
    covariates = models.l[[m]], lm_trend = T, data = sensitivity %>% filter(n_24hr.lab==n_24hr.l[[1]]) )) } )),
  do.call(rbind.data.frame, lapply(4:6, function(m) { make_pretty_lm(print_lm(
    exposure = "taste_diplos", outcome = "gluB_keep.0", label= paste0("Has 24HR: 2hr Glu~", names(models.nofast.l)[m]), 
    covariates = models.nofast.l[[m]], lm_trend = T, data = sensitivity %>% 
      filter(fast_cat=="0to2hr" & n_24hr.lab==n_24hr.l[[1]] ) )) } )) ) %>% 
  kable(caption="TAS2R38 diplotype with RG & 2hr glucose, adjusting for Fiber-to-Carbohydrate ratio ")

bind_rows(do.call(rbind.data.frame, lapply(4, function(m) { 
  make_pretty_lm(print_lm(
    exposure = "taste_diplos", outcome = "gluB_keep.0", label= paste0("No 24HR: RG~", names(models.l)[m]), 
    covariates = models.l[[m]], lm_trend = T, data = sensitivity %>% filter(n_24hr.lab==n_24hr.l[[2]]) )) } )),
  do.call(rbind.data.frame, lapply(1:4, function(m) { make_pretty_lm(print_lm(
    exposure = "taste_diplos", outcome = "gluB_keep.0", label= paste0("No 24HR: 2hr Glu~", names(models.nofast.l)[m]), 
    covariates = models.nofast.l[[m]], lm_trend = T, data = sensitivity %>% 
      filter(fast_cat=="0to2hr" & n_24hr.lab==n_24hr.l[[2]] ) )) } )) ) %>% 
  kable(caption="TAS2R38 diplotype with RG & 2hr glucose, in subset without 24HR data (comparison) ")
```

## Run sensitivity models, restricting to samples analyzed from Aliquot 1
### Aliquot 1 had the least dilution, relative to other aliquots

```{r}
## TAS2R38 diplotype & RG in diet patterns model ------------------------
sensitivity_aq1_diplo_rg <- do.call(rbind.data.frame, lapply(1:6, function(m) {
  make_pretty_lm(print_lm(exposure = "taste_diplos", outcome = "gluB_keep.0", label=names(models.noaliquot.l)[m], 
           covariates = models.noaliquot.l[[m]], lm_trend = T, data = sensitivity %>%
             filter(gluB_aliquot.0.lab == "Aliquot 1"))) }))
sensitivity_aq1_diplo_rg %>% kable(caption="TAS2R38 diplotype & RG with assay perf adjustment")

## TAS2R38 diplotype & 2hrGlu  ------------------------
sensitivity_aq1_diplo_2hrg <- make_pretty_lm(do.call(rbind.data.frame, lapply(1:6, function(m) {
  print_lm(exposure = "taste_diplos", outcome = "gluB_keep.0", label=names(models.nofast.noaliquot.l)[m], 
           covariates = models.nofast.noaliquot.l[[m]], lm_trend = T, data = sensitivity %>%
             filter(fast_cat == "0to2hr" & gluB_aliquot.0.lab == "Aliquot 1")) })))
sensitivity_aq1_diplo_2hrg %>% kable(caption="TAS2R38 diplotype & 2hr glucose with assay perf adjustment")

## TAS2R38 diplotype & HbA1c in diet patterns model ------------------------
sensitivity_aq1_diplo_a1c <- do.call(rbind.data.frame, lapply(1:6, function(m) {
  make_pretty_lm(print_lm(exposure = "taste_diplos", outcome = "hba1c", label=names(models.noaliquot.l)[m], 
           covariates = models.noaliquot.l[[m]], lm_trend = T, data = sensitivity %>%
             filter(gluB_aliquot.0.lab == "Aliquot 1"))) }))
sensitivity_aq1_diplo_a1c %>% kable(caption="TAS2R38 diplotype & HbA1c with assay perf adjustment")
```


## Run stratified analyses by sex

```{r}
sex.l<-c("Female", "Male")
models.nosex.l <- as.list(gsub("[+]sex", "", models.l)); names(models.nosex.l) <- names(models.l)
models.nosex.nofast.l <- as.list(gsub("[+]sex", "", models.nofast.l)); names(models.nosex.nofast.l) <- names(models.nofast.l)

## TAS2R38 diplotype & RG in diet patterns model ------------------------
do.call(rbind.data.frame, lapply(sex.l, function(x) {
  do.call(rbind.data.frame, lapply(1:6, function(m) { make_pretty_lm(print_lm(
    exposure = "taste_diplos", outcome = "gluB_keep.0", label=paste0(x, ": ", names(models.nosex.l)[m]), 
    covariates = models.nosex.l[[m]], lm_trend = T, data = sensitivity %>% filter(sex==x) )) })) })) %>%
  kable(caption="TAS2R38 diplotype & RG by sex")

## TAS2R38 diplotype & 2hrGlu  ------------------------
do.call(rbind.data.frame, lapply(sex.l, function(x){ 
  make_pretty_lm(do.call(rbind.data.frame, lapply(1:6, function(m) {
  print_lm(exposure = "taste_diplos", outcome = "gluB_keep.0", label=paste0(x, ":", names(models.nosex.nofast.l)[m]), 
           covariates = models.nosex.nofast.l[[m]], lm_trend = T, data = sensitivity %>%
             filter(fast_cat == "0to2hr" & sex==x)) }))) })) %>%
  kable(caption="TAS2R38 diplotype & 2hr glucose by sex")

## TAS2R38 diplotype & HbA1c in diet patterns model ------------------------
do.call(rbind.data.frame, lapply(sex.l, function(x) {
  do.call(rbind.data.frame, lapply(1:6, function(m) { make_pretty_lm(print_lm(
    exposure = "taste_diplos", outcome = "hba1c", label=paste0(x, ":", names(models.nosex.l)[m]), 
    covariates = models.nosex.l[[m]], lm_trend = T, data = sensitivity %>% filter(sex==x) )) })) })) %>%
  kable(caption="TAS2R38 diplotype & HbA1c by sex")

```



## Re-run statistical models in sub-sample at **v1**


```{r}

ukb_v1 <- readRDS("../data/processed/ukb_analysis_v1_EUR.rda")
sensitivity_v1 <- sensitivity %>% left_join(ukb_v1, by="id") 

## Calculate age.1
sensitivity_v1 <- sensitivity_v1 %>%
  mutate(age.1 = age + as.numeric(difftime(ac_date.1, ac_date, units="weeks"))/52) %>%
  filter(is.na(gluB_keep.1)==F)

# Descriptive
decr_vars_v1 <- c(
  age.1="Age, years", sex="Sex",
  bmi.1="BMI, kg/m2", smoke_level.lab.1="Smoking",
  physact_level.1="Physical Activity, MET/wk",
  alch_freq.lab.1="Alcohol Frequency", educ_level.lab.1="Education Level",
  income_level.lab.1 = "Income Level", 
  n_24hr.lab = "Complete 24HR data",
  fast_cat.1="Fasting category",
  gluB_keep.1="Glucose")

print_summary_table(data=sensitivity_v1, var_strata = "taste_diplos", vars_to_summarize = decr_vars_v1,
                    var_strata_order = c("AVI/AVI", "AVI/PAV", "PAV/PAV"),
                    factor_vars = c("n_24hr.lab", "smoke_level.lab.1", "physact_level.1", "fast_cat.1",
                                    "alch_freq.lab.1", "educ_level.lab.1", "income_level.lab.1"), p_print=T) %>% 
  kable(caption="Sample characteristics by 24HR data availability")
```

```{r}
# set up sensitivity models with v1 covariates
m_base_v1 = "age.1+sex+gPC1+gPC2+gPC3+gPC4+gPC5+gPC6+gPC7+gPC8+gPC9+gPC10+fast_cat.1"
m_bmi_v1 = paste0(m_base_v1, "+bmi.1")
m_lifestyle_v1 = paste0(m_bmi_v1, "+smoke_level.lab.1+physact_level.1+alch_freq.lab.1")
m_diet_v1 = paste0(m_lifestyle_v1, "+dietPC1+dietPC2+dietPC3+dietPC4+dietPC5+dietPC6+dietPC7+dietPC8+dietPC9+dietPC10")
m_ses_v1 = paste0(m_diet_v1, "+income_level.lab.1+educ_level.lab.1")
m_assay_v1=paste0(m_ses_v1, "+dilution_keep.1+gluB_aliquot_keep.1.lab")
m_f2c_v1 = paste0(m_ses_v1, "+FIB2CHO")
m_f2c_assay_v1 = paste0(m_f2c_v1, "+dilution_keep.1+gluB_aliquot_keep.1.lab")

models_v1.l <- list(Base=m_base_v1, BMI=m_bmi_v1, Lifestyle=m_lifestyle_v1, Diet=m_diet_v1, SES=m_ses_v1,
                    "SES+Assay"=m_assay_v1, Fib2Carb=m_f2c_v1, "Fib2Carb+Assay"=m_f2c_assay_v1)
models_v1.nofast.l <- as.list(gsub("[+]fast_cat.1", "", models_v1.l)) ; names(models_v1.nofast.l) <- names(models_v1.l)
```

**Primary analysis in total sample**
```{r}
## TAS2R38 diplotype & RG in diet patterns model ------------------------
sensitivity_v1_diplo_rg <- do.call(rbind.data.frame, lapply(1:6, function(m) {
  make_pretty_lm(print_lm(exposure = "taste_diplos", outcome = "gluB_keep.1", label=names(models_v1.l)[m], 
           covariates = models_v1.l[[m]], lm_trend = T, data = sensitivity_v1)) }))
sensitivity_v1_diplo_rg %>% kable(caption="TAS2R38 diplotype & RG with assay perf adjustment")

## TAS2R38 diplotype & 2hrGlu  ------------------------
sensitivity_v1_diplo_2hrg <- make_pretty_lm(do.call(rbind.data.frame, lapply(1:6, function(m) {
  print_lm(exposure = "taste_diplos", outcome = "gluB_keep.1", label=names(models_v1.nofast.l)[m], 
           covariates = models_v1.nofast.l[[m]], lm_trend = T, data = sensitivity_v1 %>%
             filter(fast_cat.1 == "0to2hr")) })))
sensitivity_v1_diplo_2hrg %>% kable(caption="TAS2R38 diplotype & 2hr glucose with assay perf adjustment")
```

**Stratify by sex**
```{r}
models_v1.nosex.l <- as.list(gsub("[+]sex", "", models_v1.l)); names(models_v1.nosex.l) <- names(models_v1.l)
models_v1.nosex.nofast.l <- as.list(gsub("[+]sex", "", models_v1.nofast.l)); names(models_v1.nosex.nofast.l) <- names(models_v1.nofast.l)

## TAS2R38 diplotype & RG in diet patterns model ------------------------
do.call(rbind.data.frame, lapply(sex.l, function(x) {
  do.call(rbind.data.frame, lapply(1:6, function(m) { make_pretty_lm(print_lm(
    exposure = "taste_diplos", outcome = "gluB_keep.0", label=paste0(x, ": ", names(models_v1.nosex.l)[m]), 
    covariates = models_v1.nosex.l[[m]], lm_trend = T, data = sensitivity_v1 %>% filter(sex==x) )) })) })) %>%
  kable(caption="TAS2R38 diplotype & RG by sex - visit 1")

## TAS2R38 diplotype & 2hrGlu  ------------------------
do.call(rbind.data.frame, lapply(sex.l, function(x){ 
  make_pretty_lm(do.call(rbind.data.frame, lapply(1:6, function(m) {
  print_lm(exposure = "taste_diplos", outcome = "gluB_keep.0", label=paste0(x, ":", names(models_v1.nosex.nofast.l)[m]), 
           covariates = models_v1.nosex.nofast.l[[m]], lm_trend = T, data = sensitivity_v1 %>%
             filter(fast_cat == "0to2hr" & sex==x)) }))) })) %>%
  kable(caption="TAS2R38 diplotype & 2hr glucose by sex - visit 1")

## TAS2R38 diplotype & HbA1c in diet patterns model ------------------------
do.call(rbind.data.frame, lapply(sex.l, function(x) {
  do.call(rbind.data.frame, lapply(1:6, function(m) { make_pretty_lm(print_lm(
    exposure = "taste_diplos", outcome = "hba1c", label=paste0(x, ":", names(models_v1.nosex.l)[m]), 
    covariates = models_v1.nosex.l[[m]], lm_trend = T, data = sensitivity_v1 %>% filter(sex==x) )) })) })) %>%
  kable(caption="TAS2R38 diplotype & HbA1c by sex - visit 1")
```

****


## *Re-run all analyses with NMR glucose measures*

Note: " it is important to note that the clinical chemistry in UK Biobank was measured from serum samples, primarily from aliquot 1, while the NMR biomarkers were measured from EDTA plasma samples from aliquot 3. The different aliquots are affected by different degrees of dilution, with aliquot 3 being 5–10% diluted while aliquot 1 has almost no dilution"1
*1: https://www.nature.com/articles/s41467-023-36231-7#MOESM1
*2: https://www.ncbi.nlm.nih.gov/pmc/articles/PMC7739095/pdf/wellcomeopenres-5-18211.pdf


```{r}

glu_nmr.l <- readRDS("../data/processed/nmr/ukb_nmr_glucose.rda")[[1]]
glu_nmr_processed <- glu_nmr.l$nmr_processed %>% pivot_wider(names_from = "visit_index", values_from = "Glucose", names_prefix = "gluM_proc.") 

#gather qc flags from ukbnnmr
glu_nmr_biomarker_qc_flags <- glu_nmr.l$nmr_biomarker_qc_flags %>% mutate_at("Glucose", ~ifelse(. == "", "No Flag", .)) %>%
  pivot_wider(names_from = "visit_index", values_from = "Glucose", names_prefix = "gluM_proc_qc_flag.") %>%
  rename_with(~paste0(., ".lab"), -"id")
glu_nmr_sample_qc_flags <- glu_nmr.l$sample_qc_flags %>% select(id, visit_index, Spectrometer, Processing.Batch, Low.Glucose) %>%
  mutate_at("Low.Glucose", ~ifelse(.=="Yes", "Low Glucose", "No Flag")) %>% 
  pivot_wider(id_cols="id", names_from = "visit_index", values_from = c("Spectrometer", "Processing.Batch", "Low.Glucose"), names_sep = ".") %>%
  rename_with(~paste0("gluM_proc_", ., ".lab"), -"id")

glu_nmr <- glu_nmr_processed %>% left_join(
  glu_nmr_biomarker_qc_flags, by = "id") %>% left_join(
    glu_nmr_sample_qc_flags, by="id") %>% mutate(
      across(starts_with("gluM_proc_qc_flag"), ~factor(., levels=c("No Flag", "Below limit of quantification", "High outlier plate", "Low outlier plate")))) %>%
  mutate(across(starts_with("gluM_proc_Spec"), ~factor(., levels=c(paste("Spectrometer", 1:6))))) %>%
  mutate(across(starts_with("gluM_proc_Proc"), ~factor(., levels=c(paste("Batch", 1:10)))))

glucose_nmr <- glucose %>% left_join(glu_nmr, by = "id")
glucose_nmr <- glucose_nmr %>% mutate(
  gluM_keep.0 = remove_outliers.fun(gluM_proc.0))
```

## Compare NMR to biochemical glucose
```{r}
tab_glucose_compare <- glucose_nmr %>%
  mutate(N_NMR=is.na(gluM_keep.0),N_Biohem=is.na(gluB_keep.0)) %>%
  group_by(sex, n_24hr.lab) %>%
  reframe(N_Total=n(), N_Biochem=table(N_Biohem), N_NMR=table(N_NMR),
          "Blood Glucose (keep)" = mean_sd(gluB_keep.0),"NMR Glucose (keep)" = mean_sd(gluM_keep.0)
          ) %>% kable(caption = "Comparison of glucose measures")
r2=round(cor.test(glucose_nmr$gluB_keep.0, glucose_nmr$gluM_keep.0)$estimate, 3)

p_cor_glucose_type <- glucose_nmr %>% 
  ggplot(aes(x=gluB_keep.0, y=gluM_keep.0)) +
  geom_point(color="#00000075") + 
  geom_abline(aes(slope=1, intercept=0), color="blue", linewidth=1) + 
  scale_y_continuous(limits=c(0,10)) + scale_x_continuous(limits=c(0,10)) + 
  annotate("text", x=0,y=9.9, label=paste0("r2 = ", r2), hjust=0) + 
  xlab("Biochemical Glucose") + ylab("NMR Glucose") + ggtheme_basic + 
  theme(axis.title = element_text(face="bold", size=12), 
        axis.text = element_text(size=10))

ggarrange("",p_cor_glucose_type, "",ncol=3,widths=c(0.1,1,0.1), nrow=1,common.legend = T)
```

```{r}
# function to recode parameter variables as NA for outliers of glu
recode_outlier_as_na.fun <- function(data, var_name, suffix="keep") {
  v<-gsub(".*[.]", "", gsub(".lab", "", var_name))
  temp <- data %>% select(var=all_of(var_name), glu=paste0("gluM.",v)) %>%
    mutate(char = ifelse(find_outliers.fun(glu, SDs=5)==1, NA, as.character(var)),
           num = ifelse(find_outliers.fun(glu, SDs=5)==1, NA, var))
  if(is.numeric(temp$var)) {temp <- temp %>% select(set_to_na="num") } else 
    if (is.character(temp$var)) { temp <- temp %>% select(set_to_na="char") } else 
      if(is.factor(temp$var)) { temp <- temp %>% mutate(set_to_na = factor(var, levels=c(levels(temp$var)))) %>%
        select(set_to_na) } ; new_var <- temp %>% rename_at(
      "set_to_na", ~gsub(paste0("[.]",v), paste0("_", suffix, ".", v), var_name)) 
  return(new_var)
}  

glucose_nmr <- glucose_nmr %>% mutate(
  recode_outlier_as_na.fun(., "gluM_proc_Low.Glucose.0.lab"), recode_outlier_as_na.fun(., "gluM_proc_Spectrometer.0.lab"),
  recode_outlier_as_na.fun(., "gluM_proc_qc_flag.0.lab"), recode_outlier_as_na.fun(., "gluM_proc_Processing.Batch.0.lab")
)
```

#### Examine NMR glucose & assay performance by 24HR
```{r, fig.width=10, include=F}
nmr_assays <- c(
  gluM_proc_Spectrometer_keep.0.lab="NMR glucose Spectrometer", gluM_proc_Processing.Batch_keep.0.lab="NMR glucose processing batch",
  gluM_proc_qc_flag_keep.0.lab="NMR glucose QC flags", gluM_proc_Low.Glucose.0.lab= "gluM_proc_Low.Glucose_keep.0.lab") ; print_summary_table(
    data=glucose_nmr, vars_to_summarize = nmr_assays, var_strata = "n_24hr.lab", p_types = "descriptive",
    factor_vars = names(nmr_assays)) %>% kable()

p_hist_nmr_glucose<-glucose_nmr %>% ggplot(aes(x=gluM_keep.0)) + geom_histogram() + 
  xlab("NMR glucose (processed by ukbnmr package)") + ggtheme_basic

p_gluc_24hr <- glucose_nmr %>% 
  select(n24HR=n_24hr.lab, Glucose=gluM_keep.0) %>%
  filter(complete.cases(n24HR)) %>%
  ggplot(aes(x=n24HR, y=Glucose, fill=n24HR)) +
  geom_boxplot() + geom_hline(yintercept = mean(glucose$gluM_keep.0, na.rm=T)) +  xlab("24HR data") + 
  ylab("Glucose, mmol/L") + scale_fill_manual(values=palettes$has_24hr, name="24HR data") + 
  theme(legend.position = "bottom") + ggtitle(paste0("Glucose by 24HR data")) 

ggarrange(p_hist_nmr_glucose,p_gluc_24hr,ncol=2)

p_glu_24hr_spectrometer <- glucose_nmr %>% 
  select(n24HR=n_24hr.lab, Glucose=gluM_keep.0, Spectrometer=gluM_proc_Spectrometer_keep.0.lab) %>%
  filter(complete.cases(Spectrometer)) %>%
  ggplot(aes(x=n24HR, y=Glucose, fill=n24HR)) +facet_grid(~Spectrometer) +
  geom_boxplot() + xlab("Aliquot # x 24HR data") + 
  geom_hline(yintercept = mean(glucose$gluM_keep.0, na.rm=T)) +
  ylab("Blood glucose, mmol/L") + scale_fill_manual(values=palettes$has_24hr, name="24HR data") + 
  theme(legend.position = "bottom") + ggtitle(paste0("Blood glucose by Aliquot & 24HR data")) 

p_glu_24hr_spectrometer

make_pretty_lm(print_lm(
  exposure = "gluM_proc_Spectrometer_keep.0.lab", outcome = "gluM_keep.0", covariates = "age+sex", 
  label = "Glucose ~ Spectrometer+Age+Sex", data=glucose_nmr, lm_trend = T, round = F)) %>% kable()
make_pretty_lm(print_lm_interaction(exposure="n_24hr.lab", interaction = "gluM_proc_Spectrometer_keep.0.lab", outcome="gluM_keep.0", 
    model = "age+sex", label_model = "NMR Glucose~24HR", label_interaction = "24HR x Spectrometer", data=glucose_nmr)
    ) %>% kable()

```
Stratified by fasting time
```{r}
p_gluc_24hr_fasting <- glucose_nmr %>% 
  group_by(Fasting=fasting_hrs.0, n24HR=n_24hr.lab) %>%
  reframe(mean=mean(gluM_keep.0, na.rm=T), sd=sd(gluM_keep.0, na.rm=T)) %>%
  ggplot(aes(x=Fasting, y=mean-2, ymin=mean-2-sd, ymax=mean-2+sd, fill=n24HR)) +
  scale_y_continuous(limits=c(0,3), breaks=seq(0,3,0.5), labels=seq(0,3,0.5)+2) +
  scale_x_continuous(breaks=seq(0,23,1), labels=seq(1,24,1)) +
  geom_bar(stat="identity", position=position_dodge(0.9)) + 
  geom_errorbar(position=position_dodge(0.8), linewidth=0.45, width=0.35) +
  geom_hline(yintercept = mean(glucose$gluM_keep.0, na.rm=T)-2, linetype = "dashed") +
  xlab("Fasting time, hrs") + ylab("Glucose, mmol/L") +
  scale_fill_manual(values=palettes$has_24hr, "24HR data?") + ggtheme_basic +
  ggtitle("Dilution by fasting & 24HR data")
p_gluc_24hr_fasting
```

### Run main regressions & sensitivity models adjusting for spectrometer
```{r}
models.nmr.l <- as.list(gsub("dilution_keep.0[+]gluB_aliquot_keep.0.lab", "gluM_proc_Spectrometer_keep.0.lab", models.l))
names(models.nmr.l) <- names(models.l)

models.nmr.nofast.l <- as.list(gsub("dilution_keep.0[+]gluB_aliquot_keep.0.lab", "gluM_proc_Spectrometer_keep.0.lab", models.nofast.l))
names(models.nmr.nofast.l) <- names(models.l)

sensitivity_nmr <- glucose_nmr %>% filter(find_outliers.fun(glucose_nmr$gluM_keep.0) == 0)
```

#### Adjust for dilution fraction/aliquot and SES
Total sample
```{r}
## TAS2R38 diplotype & RG in diet patterns model ------------------------
sensitivity_diplo_nmr_rg <- do.call(rbind.data.frame, lapply(1:6, function(m) {
  make_pretty_lm(print_lm(exposure = "taste_diplos", outcome = "gluB_keep.0", label=names(models.nmr.l)[m], 
           covariates = models.nmr.l[[m]], lm_trend = T, data = sensitivity_nmr)) }))
sensitivity_diplo_nmr_rg %>% kable(caption="TAS2R38 diplotype & NMR RG with assay perf adjustment")

## TAS2R38 diplotype & 2hrGlu  ------------------------
sensitivity_diplo_nmr_2hrg <- make_pretty_lm(do.call(rbind.data.frame, lapply(1:6, function(m) {
  print_lm(exposure = "taste_diplos", outcome = "gluB_keep.0", label=names(models.nmr.nofast.l)[m], 
           covariates = models.nmr.nofast.l[[m]], lm_trend = T, data = sensitivity_nmr %>%
             filter(fast_cat == "0to2hr")) })))
sensitivity_diplo_nmr_2hrg %>% kable(caption="TAS2R38 diplotype & NMR 2hr glucose with assay perf adjustment")
```

Run in models stratified by 24HR data
```{r}
k=n_24hr.l[[1]]
## TAS2R38 diplotype & RG in diet patterns model ------------------------
sensitivity_24hr_diplo_nmr_rg <- do.call(rbind.data.frame, lapply(1:6, function(m) {make_pretty_lm(
    print_lm(exposure = "taste_diplos", outcome = "gluB_keep.0", label=paste0(k, ": ", names(models.nmr.l)[m]), 
           covariates = models.nmr.l[[m]], lm_trend = T, data = sensitivity_nmr %>% 
             filter(n_24hr.lab==k))) }))
sensitivity_24hr_diplo_nmr_rg %>% kable(caption="TAS2R38 diplotype & NMR RG with assay perf adjustment = by 24hr")

## TAS2R38 diplotype & 2hrGlu  ------------------------
sensitivity_24hr_diplo_nmr_2hrg <- do.call(rbind.data.frame, lapply(1:6, function(m) { make_pretty_lm(
    print_lm(exposure = "taste_diplos", outcome = "gluB_keep.0", label=paste0(k, ": ", names(models.nmr.nofast.l)[m]), 
           covariates = models.nmr.nofast.l[[m]], lm_trend = T, data = sensitivity_nmr %>%
             filter(fast_cat == "0to2hr" & n_24hr.lab == k))) }))
sensitivity_24hr_diplo_nmr_2hrg %>% kable(caption="TAS2R38 diplotype & NMR 2hr glucose with assay perf adjustment - by 24HR")
```

#### End of sensitivity analyses for assay performance

